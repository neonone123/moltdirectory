<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Compare two sources to find shared and divergent">
  <title>principle-comparator - OpenClaw Directory</title>
  <link rel="canonical" href="https://moltdirectory.com/devops-cloud/principle-comparator/">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶û</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    // Apply saved theme before page renders to prevent flash
    (function() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      if (savedTheme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
      }
    })();
  </script>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo">

        <span class="logo-text">OpenClaw Directory</span>
      </a>
      <nav class="header-links">
        <a href="/start-here/" class="header-link">Start Here</a>
        <a href="/security-auditor" class="header-link">Security Auditor</a>
        <a href="https://github.com/neonone123/moltdirectory/issues/new?template=add-skill.yml" class="header-link" target="_blank" rel="noopener">Add Skill</a>
        <button class="theme-toggle" aria-label="Toggle theme" onclick="toggleTheme()">
          <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
        <a href="https://www.reddit.com/r/OpenClawDirectory/" class="header-link" target="_blank" rel="noopener" aria-label="Community">
          <svg viewBox="0 0 16 16" fill="currentColor" width="28" height="28"><path d="M6.167 8a.83.83 0 0 0-.83.83c0 .459.372.84.83.831a.831.831 0 0 0 0-1.661m1.843 3.647c.315 0 1.403-.038 1.976-.611a.23.23 0 0 0 0-.306.213.213 0 0 0-.306 0c-.353.363-1.126.487-1.67.487-.545 0-1.308-.124-1.671-.487a.213.213 0 0 0-.306 0 .213.213 0 0 0 0 .306c.564.563 1.652.61 1.977.61zm.992-2.807c0 .458.373.83.831.83s.83-.381.83-.83a.831.831 0 0 0-1.66 0z"/><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.828-1.165c-.315 0-.602.124-.812.325-.801-.573-1.9-.945-3.121-.993l.534-2.501 1.738.372a.83.83 0 1 0 .83-.869.83.83 0 0 0-.744.468l-1.938-.41a.2.2 0 0 0-.153.028.2.2 0 0 0-.086.134l-.592 2.788c-1.24.038-2.358.41-3.17.992-.21-.2-.496-.324-.81-.324a1.163 1.163 0 0 0-.478 2.224q-.03.17-.029.353c0 1.795 2.091 3.256 4.669 3.256s4.668-1.451 4.668-3.256c0-.114-.01-.238-.029-.353.401-.181.688-.592.688-1.069 0-.65-.525-1.165-1.165-1.165"/></svg>
        </a>
      </nav>
    </div>
  </header>
  
          <section class="skill-page-header">
            <div class="skill-page-header-inner">
              <a href="/devops-cloud/" class="back-link">‚Üê Back to DevOps & Cloud</a>
              <div class="skill-page-meta">
                <a href="/devops-cloud/" class="skill-page-category">DevOps & Cloud</a>
                <span class="skill-page-author">by @leegitw</span>
              </div>
              <h1 class="skill-page-title">principle-comparator</h1>
              <p class="skill-page-desc">Compare two sources to find shared and divergent</p>
              <div class="vote-widget skill-page-vote" data-category-id="devops-cloud" data-tool-id="principle-comparator">
                <button type="button" class="vote-btn" data-vote="1" aria-label="Upvote principle-comparator">‚ñ≤</button>
                <span class="vote-count">New</span>
                <button type="button" class="vote-btn" data-vote="-1" aria-label="Downvote principle-comparator">‚ñº</button>
              </div>
            </div>
          </section>
          <div class="skill-page-body">
            <article class="skill-page-content">
              <div class="skill-source-wrapper">
                <div class="skill-source-header">
                  <div class="skill-source-title">Source Code</div>
                  <button class="copy-btn" onclick="copySkillContent(this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    Copy
                  </button>
                </div>
                <div class="markdown-content">
                  <h1>Principle Comparator</h1>
<h2>Agent Identity</h2>
<p><strong>Role</strong>: Help users find what principles survive across different expressions
<strong>Understands</strong>: Users comparing sources need objectivity, not advocacy for either side
<strong>Approach</strong>: Compare extractions to identify invariants vs variations
<strong>Boundaries</strong>: Report observations, never determine which source is &quot;correct&quot;
<strong>Tone</strong>: Analytical, balanced, clear about confidence levels
<strong>Opening Pattern</strong>: &quot;You have two sources that might share deeper patterns ‚Äî let&#39;s find where they agree and where they diverge.&quot;</p>
<h2>When to Use</h2>
<p>Activate this skill when the user asks to:</p>
<ul>
<li>&quot;Compare these two extractions&quot;</li>
<li>&quot;What do these sources have in common?&quot;</li>
<li>&quot;Find the shared principles&quot;</li>
<li>&quot;Validate this principle against another source&quot;</li>
<li>&quot;Which ideas appear in both?&quot;</li>
</ul>
<h2>Important Limitations</h2>
<ul>
<li>Compares STRUCTURE, not correctness ‚Äî both sources could be wrong</li>
<li>Cannot determine which source is better</li>
<li>Semantic alignment requires judgment ‚Äî verify my matches</li>
<li>Works best with extractions from pbe-extractor/essence-distiller</li>
<li>N=2 is validation, not proof</li>
</ul>
<hr>
<h2>Input Requirements</h2>
<p>User provides ONE of:</p>
<ul>
<li>Two extraction outputs (from pbe-extractor or essence-distiller)</li>
<li>Two raw text sources (I&#39;ll extract first, then compare)</li>
<li>One extraction + one raw source</li>
</ul>
<h3>Input Format</h3>
<pre><code class="language-json">{
  &quot;source_a&quot;: {
    &quot;type&quot;: &quot;extraction&quot;,
    &quot;hash&quot;: &quot;a1b2c3d4&quot;,
    &quot;principles&quot;: [...]
  },
  &quot;source_b&quot;: {
    &quot;type&quot;: &quot;raw_text&quot;,
    &quot;content&quot;: &quot;...&quot;
  }
}
</code></pre>
<p>Or simply provide two pieces of content and I&#39;ll handle the rest.</p>
<hr>
<h2>Methodology</h2>
<p>This skill compares extractions to find <strong>shared and divergent principles</strong> using N-count validation.</p>
<h3>N-Count Tracking</h3>
<table>
<thead>
<tr>
<th>N-Count</th>
<th>Status</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td>N=1</td>
<td>Observation</td>
<td>Single source, needs validation</td>
</tr>
<tr>
<td>N=2</td>
<td>Validated</td>
<td>Two independent sources agree</td>
</tr>
<tr>
<td>N‚â•3</td>
<td>Invariant</td>
<td>Candidate for Golden Master</td>
</tr>
</tbody></table>
<h3>Semantic Alignment (on Normalized Forms)</h3>
<p>Two principles are semantically aligned when their <strong>normalized forms</strong> express the same core value:</p>
<p><strong>Aligned</strong> (same normalized meaning):</p>
<ul>
<li>A: &quot;Values truthfulness over comfort&quot;</li>
<li>B: &quot;Values honesty in difficult situations&quot;</li>
<li>Alignment: HIGH ‚Äî both normalize to &quot;Values honesty/truthfulness&quot;</li>
</ul>
<p><strong>Not Aligned</strong> (different meanings):</p>
<ul>
<li>A: &quot;Values speed in delivery&quot;</li>
<li>B: &quot;Values safety in delivery&quot;</li>
<li>Alignment: NONE ‚Äî speed ‚â† safety despite similar structure</li>
</ul>
<p><strong>Aligned</strong>: &quot;Fail fast&quot; (Source A) ‚âà &quot;Expose errors immediately&quot; (Source B)
<strong>Not Aligned</strong>: &quot;Fail fast&quot; ‚âà &quot;Fail safely&quot; (keyword overlap, different meaning)</p>
<h3>Normalized Form Selection (Conflict Resolution)</h3>
<p>When two principles align, select the canonical normalized form using these criteria (in order):</p>
<ol>
<li><strong>More abstract</strong>: Prefer the form with broader applicability</li>
<li><strong>Higher confidence</strong>: Prefer the form from the higher-confidence source</li>
<li><strong>Tie-breaker</strong>: Use Source A&#39;s normalized form</li>
</ol>
<p>This ensures reproducible outputs when principles from different sources are semantically equivalent but have different normalized phrasings.</p>
<h3>Promotion Rules</h3>
<ul>
<li><strong>N=1 ‚Üí N=2</strong>: Requires semantic alignment between two extractions</li>
<li><strong>Contradiction handling</strong>: If sources disagree, principle stays at N=1 with <code>divergence_note</code></li>
</ul>
<hr>
<h2>Comparison Framework</h2>
<h3>Step 0: Normalize All Principles</h3>
<p>Before comparing, normalize all principles from both sources:</p>
<ul>
<li>Transform to actor-agnostic, imperative form</li>
<li>This enables semantic alignment across different phrasings</li>
</ul>
<p><strong>Why normalize first?</strong></p>
<table>
<thead>
<tr>
<th>Source A (raw)</th>
<th>Source B (raw)</th>
<th>Match?</th>
</tr>
</thead>
<tbody><tr>
<td>&quot;I tell the truth&quot;</td>
<td>&quot;Honesty matters most&quot;</td>
<td>Unclear</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Source A (normalized)</th>
<th>Source B (normalized)</th>
<th>Match?</th>
</tr>
</thead>
<tbody><tr>
<td>&quot;Values truthfulness&quot;</td>
<td>&quot;Values honesty above all&quot;</td>
<td>Yes!</td>
</tr>
</tbody></table>
<p><strong>Normalization Rules</strong>:</p>
<ol>
<li>Remove pronouns (I, we, you, my, our, your)</li>
<li>Use imperative: &quot;Values X&quot;, &quot;Prioritizes Y&quot;, &quot;Avoids Z&quot;, &quot;Maintains Y&quot;</li>
<li>Abstract domain terms, preserve magnitude in parentheses</li>
<li>Keep conditionals if present</li>
<li>Single sentence, under 100 characters</li>
</ol>
<p><strong>When NOT to normalize</strong> (set <code>normalization_status: &quot;skipped&quot;</code>):</p>
<ul>
<li>Context-bound principles</li>
<li>Numerical thresholds integral to meaning</li>
<li>Process-specific step sequences</li>
</ul>
<h3>Step 1: Align Extractions</h3>
<p>For each principle in Source A:</p>
<ul>
<li>Search Source B for semantic match using <strong>normalized forms</strong></li>
<li>Score alignment confidence</li>
<li>Note evidence from both sources</li>
</ul>
<h3>Step 2: Classify Results</h3>
<table>
<thead>
<tr>
<th>Category</th>
<th>Definition</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Shared</strong></td>
<td>Principle appears in both with semantic alignment</td>
</tr>
<tr>
<td><strong>Source A Only</strong></td>
<td>Principle only in A (unique or missing from B)</td>
</tr>
<tr>
<td><strong>Source B Only</strong></td>
<td>Principle only in B (unique or missing from A)</td>
</tr>
<tr>
<td><strong>Divergent</strong></td>
<td>Similar topic but different conclusions</td>
</tr>
</tbody></table>
<h3>Step 3: Analyze Divergence</h3>
<p>For principles that appear differently:</p>
<ul>
<li><strong>Domain-specific</strong>: Valid in different contexts</li>
<li><strong>Version drift</strong>: Same concept, evolved differently</li>
<li><strong>Contradiction</strong>: Genuinely conflicting claims</li>
</ul>
<hr>
<h2>Output Schema</h2>
<pre><code class="language-json">{
  &quot;operation&quot;: &quot;compare&quot;,
  &quot;metadata&quot;: {
    &quot;source_a_hash&quot;: &quot;a1b2c3d4&quot;,
    &quot;source_b_hash&quot;: &quot;e5f6g7h8&quot;,
    &quot;timestamp&quot;: &quot;2026-02-04T12:00:00Z&quot;,
    &quot;normalization_version&quot;: &quot;v1.0.0&quot;
  },
  &quot;result&quot;: {
    &quot;shared_principles&quot;: [
      {
        &quot;id&quot;: &quot;SP1&quot;,
        &quot;source_a_original&quot;: &quot;I always tell the truth&quot;,
        &quot;source_b_original&quot;: &quot;Honesty matters most&quot;,
        &quot;normalized_form&quot;: &quot;Values truthfulness in communication&quot;,
        &quot;normalization_status&quot;: &quot;success&quot;,
        &quot;confidence&quot;: &quot;high&quot;,
        &quot;n_count&quot;: 2,
        &quot;alignment_confidence&quot;: &quot;high&quot;,
        &quot;alignment_note&quot;: &quot;Identical meaning, different wording&quot;
      }
    ],
    &quot;source_a_only&quot;: [
      {
        &quot;id&quot;: &quot;A1&quot;,
        &quot;statement&quot;: &quot;Keep functions small&quot;,
        &quot;normalized_form&quot;: &quot;Values concise units of work (~50 lines)&quot;,
        &quot;normalization_status&quot;: &quot;success&quot;,
        &quot;n_count&quot;: 1
      }
    ],
    &quot;source_b_only&quot;: [
      {
        &quot;id&quot;: &quot;B1&quot;,
        &quot;statement&quot;: &quot;Principle unique to source B&quot;,
        &quot;normalized_form&quot;: &quot;...&quot;,
        &quot;normalization_status&quot;: &quot;success&quot;,
        &quot;n_count&quot;: 1
      }
    ],
    &quot;divergence_analysis&quot;: {
      &quot;total_divergent&quot;: 3,
      &quot;domain_specific&quot;: 2,
      &quot;version_drift&quot;: 1,
      &quot;contradictions&quot;: 0
    }
  },
  &quot;next_steps&quot;: [
    &quot;Add a third source and run principle-synthesizer to confirm invariants (N=2 ‚Üí N‚â•3)&quot;,
    &quot;Investigate divergent principles ‚Äî are they domain-specific or version drift?&quot;
  ]
}
</code></pre>
<p><code>normalization_status</code> values:</p>
<ul>
<li><code>&quot;success&quot;</code>: Normalized without issues</li>
<li><code>&quot;failed&quot;</code>: Could not normalize, using original</li>
<li><code>&quot;drift&quot;</code>: Meaning may have changed, added to <code>requires_review.md</code></li>
<li><code>&quot;skipped&quot;</code>: Intentionally not normalized (context-bound, numerical, process-specific)</li>
</ul>
<h3>share_text (When Applicable)</h3>
<p>Included only when high-confidence N=2 invariant is identified:</p>
<pre><code class="language-json">&quot;share_text&quot;: &quot;Two independent sources, same principle ‚Äî N=2 validated ‚úì obviouslynot.ai/pbd/{source_hash}&quot;
</code></pre>
<p>Not triggered by count alone ‚Äî requires genuine semantic alignment.</p>
<p><strong>Note</strong>: The URL pattern <code>obviouslynot.ai/pbd/{source_hash}</code> is illustrative. Actual URL structure depends on deployment configuration.</p>
<hr>
<h2>Alignment Confidence</h2>
<table>
<thead>
<tr>
<th>Level</th>
<th>Criteria</th>
</tr>
</thead>
<tbody><tr>
<td><strong>High</strong></td>
<td>Identical meaning, clear paraphrase</td>
</tr>
<tr>
<td><strong>Medium</strong></td>
<td>Related meaning, some inference required</td>
</tr>
<tr>
<td><strong>Low</strong></td>
<td>Possible connection, significant interpretation</td>
</tr>
</tbody></table>
<hr>
<h2>Terminology Rules</h2>
<table>
<thead>
<tr>
<th>Term</th>
<th>Use For</th>
<th>Never Use For</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Shared</strong></td>
<td>Principles appearing in both sources</td>
<td>Keyword matches</td>
</tr>
<tr>
<td><strong>Aligned</strong></td>
<td>Semantic match passing rephrasing test</td>
<td>Surface similarity</td>
</tr>
<tr>
<td><strong>Divergent</strong></td>
<td>Same topic, different conclusions</td>
<td>Unrelated principles</td>
</tr>
<tr>
<td><strong>Invariant</strong></td>
<td>N‚â•2 with high alignment confidence</td>
<td>Any shared principle</td>
</tr>
</tbody></table>
<hr>
<h2>Error Handling</h2>
<table>
<thead>
<tr>
<th>Error Code</th>
<th>Trigger</th>
<th>Message</th>
<th>Suggestion</th>
</tr>
</thead>
<tbody><tr>
<td><code>EMPTY_INPUT</code></td>
<td>Missing source</td>
<td>&quot;I need two sources to compare.&quot;</td>
<td>&quot;Provide two extractions or two text sources.&quot;</td>
</tr>
<tr>
<td><code>SOURCE_MISMATCH</code></td>
<td>Incompatible domains</td>
<td>&quot;These sources seem to be about different topics.&quot;</td>
<td>&quot;Comparison works best with sources covering the same domain.&quot;</td>
</tr>
<tr>
<td><code>NO_OVERLAP</code></td>
<td>Zero shared principles</td>
<td>&quot;I couldn&#39;t find any shared principles.&quot;</td>
<td>&quot;The sources may be genuinely independent, or try broader extraction.&quot;</td>
</tr>
<tr>
<td><code>INVALID_HASH</code></td>
<td>Hash not recognized</td>
<td>&quot;I don&#39;t recognize that source reference.&quot;</td>
<td>&quot;Use source_hash from a previous extraction.&quot;</td>
</tr>
</tbody></table>
<hr>
<h2>Related Skills</h2>
<ul>
<li><strong>pbe-extractor</strong>: Extract principles before comparing (technical voice)</li>
<li><strong>essence-distiller</strong>: Extract principles before comparing (conversational voice)</li>
<li><strong>principle-synthesizer</strong>: Synthesize 3+ sources to find Golden Masters (N‚â•3)</li>
<li><strong>pattern-finder</strong>: Conversational alternative to this skill</li>
<li><strong>golden-master</strong>: Track source/derived relationships after comparison</li>
</ul>
<hr>
<h2>Required Disclaimer</h2>
<p>This skill compares STRUCTURE, not truth. Shared principles mean both sources express the same idea ‚Äî not that the idea is correct. Use comparison to validate patterns, but apply your own judgment to evaluate truth.</p>
<hr>
<p><em>Built by Obviously Not ‚Äî Tools for thought, not conclusions.</em></p>

                </div>
              </div>
            </article>
            <aside class="skill-page-sidebar">
              <div class="sidebar-card">
                <div class="sidebar-title">Actions</div>
                <a href="https://github.com/openclaw/skills/tree/main/skills/leegitw/principle-comparator/SKILL.md" target="_blank" rel="noopener" class="sidebar-btn sidebar-btn-primary">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
                  View on GitHub
                </a>
                <a href="https://clawdhub.com/leegitw/principle-comparator" target="_blank" rel="noopener" class="sidebar-btn sidebar-btn-clawdhub">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><line x1="2" y1="12" x2="22" y2="12"/></svg>
                  View on ClawdHub
                </a>
                <a href="https://raw.githubusercontent.com/openclaw/skills/main/skills/leegitw/principle-comparator/SKILL.md" download="SKILL.md" class="sidebar-btn sidebar-btn-secondary">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                  Download SKILL.md
                </a>
                <button onclick="sendToSecurityAuditor()" class="sidebar-btn sidebar-btn-security">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                  Security Check
                </button>
              </div>
              <div class="sidebar-card">
                <div class="sidebar-title">Details</div>
                <div class="sidebar-info">
                  <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Author</span>
                    <span class="sidebar-info-value">@leegitw</span>
                  </div>
                  <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Category</span>
                    <span class="sidebar-info-value">DevOps & Cloud</span>
                  </div>
                </div>
              </div>
            </aside>
          </div>
        
  <footer class="footer">
    <div class="footer-inner">
      <p class="footer-text" style="margin-bottom: 8px;"><a href="https://github.com/neonone123/moltdirectory" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none;">View on GitHub</a></p>
      <p class="footer-text" style="opacity: 0.6; font-size: 13px;">OpenClawDirectory.com is a community-run project and is not affiliated with the official OpenClaw team or Peter Steinberger. We are just fans of the lobster.</p>
    </div>
  </footer>
  <script>
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      if (newTheme === 'light') {
        html.setAttribute('data-theme', 'light');
      } else {
        html.removeAttribute('data-theme');
      }
      localStorage.setItem('theme', newTheme);
    }
    
    function copySkillContent(btn) {
      const wrapper = btn.closest('.skill-source-wrapper');
      const content = wrapper.querySelector('.markdown-content');
      if (content) {
        const text = content.innerText || content.textContent;
        navigator.clipboard.writeText(text).then(() => {
          btn.classList.add('copied');
          btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> Copied!';
          setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy';
          }, 2000);
        });
      }
    }

    async function sendToSecurityAuditor() {
      try {
        const contentElement = document.querySelector('.markdown-content');
        if (!contentElement) throw new Error('Could not find markdown content');
        const skillContent = contentElement.innerText || contentElement.textContent;
        localStorage.setItem('skillAuditContent', skillContent);
        window.open('/security-auditor', '_blank'); 
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function updateVoteWidget(widget, toolData) {
      if (!widget || !toolData) return;
      const upBtn = widget.querySelector('[data-vote="1"]');
      const downBtn = widget.querySelector('[data-vote="-1"]');
      const countNode = widget.querySelector('.vote-count');
      widget.dataset.rankScore = String(toolData.rankScore ?? 0);
      widget.dataset.viewerVote = String(toolData.viewerVote ?? 0);

      if (countNode) {
        countNode.textContent = toolData.displayCount || 'New';
      }
      if (upBtn) {
        upBtn.classList.toggle('is-active', Number(toolData.viewerVote) === 1);
      }
      if (downBtn) {
        downBtn.classList.toggle('is-active', Number(toolData.viewerVote) === -1);
      }
    }

    function setWidgetBusy(widget, busy) {
      widget.dataset.busy = busy ? '1' : '0';
      widget.querySelectorAll('.vote-btn').forEach((btn) => {
        btn.disabled = busy;
      });
    }

    function applySortMode(grid, mode) {
      const cards = [...grid.querySelectorAll('.skill-card[data-tool-id]')];
      cards.sort((a, b) => {
        if (mode === 'community') {
          const scoreDiff = Number(b.dataset.rankScore || 0) - Number(a.dataset.rankScore || 0);
          if (scoreDiff !== 0) return scoreDiff;
        }
        return Number(a.dataset.originalIndex || 0) - Number(b.dataset.originalIndex || 0);
      });
      cards.forEach((card) => grid.appendChild(card));
    }

    function bindSortToggle(toolbar, grid) {
      const buttons = toolbar.querySelectorAll('.sort-toggle-btn');
      const status = toolbar.querySelector('.sort-status');
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const mode = btn.dataset.sortMode;
          buttons.forEach((b) => b.classList.toggle('is-active', b === btn));
          applySortMode(grid, mode);
          status.textContent = mode === 'community' ? 'Community ranking active' : 'Original order active';
        });
      });
    }

    async function fetchScores(categoryId, toolIds) {
      const params = new URLSearchParams({
        categoryId,
        toolIds: toolIds.join(',')
      });
      const response = await fetch('/api/v1/scores?' + params.toString(), {
        method: 'GET',
        credentials: 'same-origin'
      });
      if (!response.ok) {
        throw new Error('Unable to fetch vote scores');
      }
      return response.json();
    }

    async function submitVote(widget, voteValue) {
      const categoryId = widget.dataset.categoryId;
      const toolId = widget.dataset.toolId;
      setWidgetBusy(widget, true);
      try {
        const response = await fetch('/api/v1/vote', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            categoryId,
            toolId,
            vote: voteValue
          })
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload.error || 'Vote request failed');
        }
        if (payload.tool) {
          updateVoteWidget(widget, payload.tool);
          const card = widget.closest('.skill-card[data-tool-id]');
          if (card) {
            card.dataset.rankScore = String(payload.tool.rankScore ?? 0);
          }
        }
      } catch (error) {
        console.error(error);
      } finally {
        setWidgetBusy(widget, false);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const widgets = [...document.querySelectorAll('.vote-widget[data-category-id][data-tool-id]')];
      if (widgets.length === 0) return;

      const grouped = new Map();
      widgets.forEach((widget) => {
        const key = widget.dataset.categoryId;
        if (!grouped.has(key)) grouped.set(key, new Map());
        grouped.get(key).set(widget.dataset.toolId, widget);
      });

      for (const [categoryId, widgetMap] of grouped.entries()) {
        const toolIds = [...widgetMap.keys()];
        try {
          const data = await fetchScores(categoryId, toolIds);
          const byTool = new Map((data.tools || []).map((tool) => [tool.toolId, tool]));
          for (const [toolId, widget] of widgetMap.entries()) {
            const toolData = byTool.get(toolId);
            if (toolData) {
              updateVoteWidget(widget, toolData);
              const card = widget.closest('.skill-card[data-tool-id]');
              if (card) {
                card.dataset.rankScore = String(toolData.rankScore ?? 0);
              }
            }
          }
        } catch (error) {
          console.error(error);
        }
      }

      widgets.forEach((widget) => {
        widget.querySelectorAll('.vote-btn').forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            if (widget.dataset.busy === '1') return;
            const voteValue = Number(btn.dataset.vote);
            submitVote(widget, voteValue).then(() => {
              const grid = widget.closest('.skills-grid[data-category-id]');
              const toolbar = document.querySelector('.sort-toolbar[data-category-id="' + widget.dataset.categoryId + '"]');
              const communityBtn = toolbar ? toolbar.querySelector('.sort-toggle-btn[data-sort-mode="community"]') : null;
              if (grid && communityBtn && communityBtn.classList.contains('is-active')) {
                applySortMode(grid, 'community');
              }
            });
          });
        });
      });

      document.querySelectorAll('.skills-grid[data-category-id]').forEach((grid) => {
        const categoryId = grid.dataset.categoryId;
        const toolbar = document.querySelector('.sort-toolbar[data-category-id="' + categoryId + '"]');
        if (!toolbar) return;
        bindSortToggle(toolbar, grid);
        applySortMode(grid, 'community');
      });
    });
  </script>
</body>
</html>