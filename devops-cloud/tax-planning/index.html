<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Plan and manage taxes effectively as a solopreneur to minimize">
  <title>tax-planning - OpenClaw Directory</title>
  <link rel="canonical" href="https://moltdirectory.com/devops-cloud/tax-planning/">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶û</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    // Apply saved theme before page renders to prevent flash
    (function() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      if (savedTheme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
      }
    })();
  </script>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo">

        <span class="logo-text">OpenClaw Directory</span>
      </a>
      <nav class="header-links">
        <a href="/start-here/" class="header-link">Start Here</a>
        <a href="/security-auditor" class="header-link">Security Auditor</a>
        <a href="https://github.com/neonone123/moltdirectory/issues/new?template=add-skill.yml" class="header-link" target="_blank" rel="noopener">Add Skill</a>
        <button class="theme-toggle" aria-label="Toggle theme" onclick="toggleTheme()">
          <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
        <a href="https://www.reddit.com/r/OpenClawDirectory/" class="header-link" target="_blank" rel="noopener" aria-label="Community">
          <svg viewBox="0 0 16 16" fill="currentColor" width="28" height="28"><path d="M6.167 8a.83.83 0 0 0-.83.83c0 .459.372.84.83.831a.831.831 0 0 0 0-1.661m1.843 3.647c.315 0 1.403-.038 1.976-.611a.23.23 0 0 0 0-.306.213.213 0 0 0-.306 0c-.353.363-1.126.487-1.67.487-.545 0-1.308-.124-1.671-.487a.213.213 0 0 0-.306 0 .213.213 0 0 0 0 .306c.564.563 1.652.61 1.977.61zm.992-2.807c0 .458.373.83.831.83s.83-.381.83-.83a.831.831 0 0 0-1.66 0z"/><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.828-1.165c-.315 0-.602.124-.812.325-.801-.573-1.9-.945-3.121-.993l.534-2.501 1.738.372a.83.83 0 1 0 .83-.869.83.83 0 0 0-.744.468l-1.938-.41a.2.2 0 0 0-.153.028.2.2 0 0 0-.086.134l-.592 2.788c-1.24.038-2.358.41-3.17.992-.21-.2-.496-.324-.81-.324a1.163 1.163 0 0 0-.478 2.224q-.03.17-.029.353c0 1.795 2.091 3.256 4.669 3.256s4.668-1.451 4.668-3.256c0-.114-.01-.238-.029-.353.401-.181.688-.592.688-1.069 0-.65-.525-1.165-1.165-1.165"/></svg>
        </a>
      </nav>
    </div>
  </header>
  
          <section class="skill-page-header">
            <div class="skill-page-header-inner">
              <a href="/devops-cloud/" class="back-link">‚Üê Back to DevOps & Cloud</a>
              <div class="skill-page-meta">
                <a href="/devops-cloud/" class="skill-page-category">DevOps & Cloud</a>
                <span class="skill-page-author">by @jk-0001</span>
              </div>
              <h1 class="skill-page-title">tax-planning</h1>
              <p class="skill-page-desc">Plan and manage taxes effectively as a solopreneur to minimize</p>
              <div class="vote-widget skill-page-vote" data-category-id="devops-cloud" data-tool-id="tax-planning">
                <button type="button" class="vote-btn" data-vote="1" aria-label="Upvote tax-planning">‚ñ≤</button>
                <span class="vote-count">New</span>
                <button type="button" class="vote-btn" data-vote="-1" aria-label="Downvote tax-planning">‚ñº</button>
              </div>
            </div>
          </section>
          <div class="skill-page-body">
            <article class="skill-page-content">
              <div class="skill-source-wrapper">
                <div class="skill-source-header">
                  <div class="skill-source-title">Source Code</div>
                  <button class="copy-btn" onclick="copySkillContent(this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    Copy
                  </button>
                </div>
                <div class="markdown-content">
                  <h1>Tax Planning</h1>
<h2>Overview</h2>
<p>Taxes are one of the biggest expenses for solopreneurs. Without planning, you&#39;ll overpay or face penalties. With planning, you can legally minimize your tax burden and keep more of what you earn. This playbook covers tax fundamentals, quarterly payments, deductions, and strategic decisions like S-Corp election. <strong>Disclaimer: This is educational content, not professional tax advice. Consult a CPA for your specific situation.</strong></p>
<hr>
<h2>Step 1: Understand Your Tax Obligations (U.S.)</h2>
<p>As a solopreneur, you pay multiple types of taxes. Know what you owe.</p>
<p><strong>Tax types:</strong></p>
<table>
<thead>
<tr>
<th>Tax Type</th>
<th>What It Is</th>
<th>Rate</th>
<th>When You Pay</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Income Tax</strong></td>
<td>Federal tax on profit</td>
<td>10-37% (marginal brackets)</td>
<td>Quarterly estimated + April 15</td>
</tr>
<tr>
<td><strong>Self-Employment Tax</strong></td>
<td>Social Security + Medicare</td>
<td>15.3% on net earnings</td>
<td>Quarterly estimated + April 15</td>
</tr>
<tr>
<td><strong>State Income Tax</strong></td>
<td>State tax on profit (if applicable)</td>
<td>0-13% (varies by state)</td>
<td>Quarterly estimated + state deadline</td>
</tr>
<tr>
<td><strong>Sales Tax</strong> (if selling physical goods)</td>
<td>Tax on sales to customers</td>
<td>Varies by state</td>
<td>Monthly or quarterly</td>
</tr>
</tbody></table>
<p><strong>Total effective tax rate for solopreneurs:</strong> 25-40% of profit (depending on income level and state).</p>
<p><strong>Example:</strong></p>
<pre><code>Net Profit: $100,000
Federal Income Tax (~22%): $22,000
Self-Employment Tax (15.3%): $15,300
State Income Tax (~5%): $5,000
Total Tax: $42,300 (42% effective rate)
</code></pre>
<p><strong>Rule:</strong> Set aside 30% of every payment you receive for taxes. Transfer it to a separate savings account immediately.</p>
<hr>
<h2>Step 2: Make Quarterly Estimated Tax Payments</h2>
<p>If you&#39;re self-employed, you don&#39;t have an employer withholding taxes. You must pay quarterly.</p>
<p><strong>Quarterly tax deadlines (U.S.):</strong></p>
<ul>
<li>Q1: April 15</li>
<li>Q2: June 15</li>
<li>Q3: September 15</li>
<li>Q4: January 15 (following year)</li>
</ul>
<p><strong>How much to pay each quarter:</strong></p>
<pre><code>Estimated Annual Profit √ó Effective Tax Rate / 4
</code></pre>
<p>Example:</p>
<pre><code>Expected profit: $100,000
Effective rate: 30%
Quarterly payment: $100,000 √ó 0.30 / 4 = $7,500
</code></pre>
<p><strong>How to pay:</strong></p>
<ul>
<li>Federal: IRS Direct Pay (irs.gov/payments) or EFTPS</li>
<li>State: Your state&#39;s tax website</li>
</ul>
<p><strong>Penalties for not paying quarterly:</strong></p>
<ul>
<li>IRS charges underpayment penalties (~5-6% annually on what you owe)</li>
<li>Safe harbor rule: If you pay 100% of last year&#39;s tax liability (110% if income &gt; $150K), you avoid penalties even if you underpay this year</li>
</ul>
<p><strong>Rule:</strong> Pay quarterly even if it&#39;s an estimate. Better to overpay slightly and get a refund than underpay and face penalties.</p>
<hr>
<h2>Step 3: Maximize Your Tax Deductions</h2>
<p>Deductions reduce your taxable income. More deductions = less tax owed.</p>
<p><strong>Top deductions for solopreneurs (U.S.):</strong></p>
<h3>1. Home Office Deduction</h3>
<p>If you have a dedicated space for business, you can deduct a portion of rent/mortgage, utilities, insurance.</p>
<p><strong>Two methods:</strong></p>
<ul>
<li><strong>Simplified:</strong> $5/sq ft (max 300 sq ft = $1,500/year)</li>
<li><strong>Actual expenses:</strong> (Home office sq ft / Total home sq ft) √ó Total home expenses</li>
</ul>
<p>Example:</p>
<pre><code>Office: 150 sq ft
Home: 1,500 sq ft
Home expenses (rent + utilities): $24,000/year
Deduction: (150/1,500) √ó $24,000 = $2,400
</code></pre>
<p><strong>Requirements:</strong></p>
<ul>
<li>Space must be used EXCLUSIVELY for business (no dual-purpose rooms)</li>
<li>Must be your principal place of business</li>
</ul>
<h3>2. Business Equipment and Supplies</h3>
<ul>
<li>Computers, monitors, desks, chairs</li>
<li>Software subscriptions (Notion, Adobe, hosting, domain)</li>
<li>Office supplies (pens, paper, printer)</li>
</ul>
<p><strong>Section 179 deduction:</strong> Deduct full cost of equipment in year purchased (up to ~$1M), rather than depreciating over years.</p>
<h3>3. Vehicle and Mileage</h3>
<p>If you drive for business (client meetings, site visits, errands):</p>
<ul>
<li><strong>Standard mileage rate:</strong> $0.67/mile (2024 rate ‚Äî check current year)</li>
<li><strong>Actual expenses:</strong> Track gas, maintenance, insurance, depreciation (complex, requires detailed records)</li>
</ul>
<p><strong>Recommendation:</strong> Use standard mileage (simpler). Track with app (MileIQ, Everlance).</p>
<p><strong>Not deductible:</strong> Commuting from home to office.</p>
<h3>4. Professional Services</h3>
<ul>
<li>CPA / tax preparation fees</li>
<li>Lawyer fees (contracts, legal advice)</li>
<li>Business consultants or coaches</li>
</ul>
<h3>5. Marketing and Advertising</h3>
<ul>
<li>Paid ads (Google, Facebook, LinkedIn)</li>
<li>Website costs (hosting, domain, design)</li>
<li>Content creation (copywriters, designers, video editors)</li>
</ul>
<h3>6. Business Travel and Meals</h3>
<ul>
<li><strong>Travel:</strong> 100% deductible (flights, hotels for business trips)</li>
<li><strong>Meals:</strong> 50% deductible (business meals with clients or networking)</li>
</ul>
<p><strong>Rule:</strong> Keep receipts and note the business purpose.</p>
<h3>7. Education and Training</h3>
<ul>
<li>Courses, books, conferences related to your business</li>
<li>Must improve skills for current business (not for entering a new field)</li>
</ul>
<h3>8. Contractor and Employee Payments</h3>
<ul>
<li>Payments to contractors (if you issue 1099s)</li>
<li>Payroll expenses (if you have employees)</li>
</ul>
<h3>9. Health Insurance (if self-employed)</h3>
<ul>
<li>100% of health insurance premiums deductible (for you and family)</li>
<li>Deducted on personal return (Form 1040), not business return</li>
</ul>
<h3>10. Retirement Contributions</h3>
<ul>
<li>Solo 401(k): Contribute up to $23,000 (2024 limit) + 25% of net earnings (total max ~$69,000)</li>
<li>SEP-IRA: Contribute up to 25% of net earnings (max ~$69,000)</li>
</ul>
<p><strong>Why this matters:</strong> Reduces taxable income AND builds retirement savings.</p>
<hr>
<h2>Step 4: Decide If You Should Elect S-Corp Status</h2>
<p>If your profit is &gt; $80-100K/year, S-Corp election can save you thousands on self-employment tax.</p>
<p><strong>How S-Corp saves money:</strong></p>
<p>As a sole proprietor or default LLC, you pay 15.3% self-employment tax on ALL profit.</p>
<p>As an S-Corp, you:</p>
<ol>
<li>Pay yourself a &quot;reasonable salary&quot; (subject to payroll taxes)</li>
<li>Take remaining profit as &quot;distributions&quot; (NOT subject to self-employment tax)</li>
</ol>
<p><strong>Example:</strong></p>
<pre><code>Profit: $150,000

DEFAULT LLC:
  Self-employment tax: $150,000 √ó 15.3% = $22,950

S-CORP:
  Reasonable salary: $80,000
  Self-employment tax on salary: $80,000 √ó 15.3% = $12,240
  Distributions (no self-employment tax): $70,000
  Total self-employment tax: $12,240
  
SAVINGS: $22,950 - $12,240 = $10,710/year
</code></pre>
<p><strong>S-Corp downsides:</strong></p>
<ul>
<li>Requires payroll setup (payroll provider ~$500-1,500/year)</li>
<li>More paperwork (payroll taxes, quarterly filings)</li>
<li>Must pay yourself a &quot;reasonable salary&quot; (can&#39;t pay $20K salary on $150K profit ‚Äî IRS will challenge it)</li>
</ul>
<p><strong>When to elect S-Corp:</strong></p>
<ul>
<li>Profit &gt; $80-100K/year (savings outweigh the extra costs)</li>
<li>You&#39;re willing to run payroll</li>
</ul>
<p><strong>When NOT to elect S-Corp:</strong></p>
<ul>
<li>Profit &lt; $60K/year (savings too small to justify extra work)</li>
<li>You&#39;re just starting out (wait until profit is consistent)</li>
</ul>
<p><strong>How to elect:</strong> File Form 2553 with IRS. Must be done by March 15 of the year you want it to take effect (or within 75 days of forming your LLC).</p>
<p><strong>Rule:</strong> Talk to a CPA before electing S-Corp. They&#39;ll help you determine if it&#39;s worth it and set up payroll.</p>
<hr>
<h2>Step 5: Year-End Tax Planning (October-December)</h2>
<p>The last 3 months of the year are critical for tax planning.</p>
<p><strong>Year-end tax checklist:</strong></p>
<h3>October: Project Your Tax Liability</h3>
<ul>
<li><input disabled="" type="checkbox"> Calculate expected profit for the year (revenue - expenses so far + projected Q4)</li>
<li><input disabled="" type="checkbox"> Estimate total tax owed (federal + state + self-employment)</li>
<li><input disabled="" type="checkbox"> Check if you&#39;ve paid enough in quarterly taxes</li>
<li><input disabled="" type="checkbox"> If underpaid, make a larger Q4 payment (Jan 15 deadline)</li>
</ul>
<h3>November: Accelerate Deductions (if profitable)</h3>
<p>If you&#39;re having a profitable year and want to reduce taxes:</p>
<ul>
<li><input disabled="" type="checkbox"> Buy equipment or software you were planning to buy in January (deduct in current year)</li>
<li><input disabled="" type="checkbox"> Pay annual subscriptions early (if you&#39;re cash-method taxpayer)</li>
<li><input disabled="" type="checkbox"> Make retirement contributions (Solo 401k or SEP-IRA)</li>
<li><input disabled="" type="checkbox"> Prepay business expenses (insurance, rent) if it makes sense</li>
</ul>
<p><strong>Caution:</strong> Don&#39;t buy things you don&#39;t need just for the tax deduction. A deduction saves you 25-40% of the expense ‚Äî you still spent the full amount.</p>
<h3>December: Defer Income (if needed)</h3>
<p>If you&#39;re having a very high-income year and want to spread it out:</p>
<ul>
<li><input disabled="" type="checkbox"> Delay invoicing until January (so payment hits next year)</li>
<li><input disabled="" type="checkbox"> Defer year-end bonuses or distributions until January</li>
</ul>
<p><strong>When to defer:</strong> If you&#39;re in a high tax bracket this year but expect lower income next year.</p>
<h3>January: File Taxes (or Hire a CPA)</h3>
<ul>
<li><input disabled="" type="checkbox"> Generate P&amp;L for the year (from accounting software)</li>
<li><input disabled="" type="checkbox"> Compile receipts for major expenses</li>
<li><input disabled="" type="checkbox"> Hand off to CPA, or use tax software (TurboTax, TaxAct)</li>
<li><input disabled="" type="checkbox"> File by April 15 (or request extension to October 15)</li>
</ul>
<hr>
<h2>Step 6: Work with a CPA</h2>
<p><strong>When to hire a CPA:</strong></p>
<ul>
<li>Revenue &gt; $50K/year (DIY becomes risky)</li>
<li>Considering S-Corp election</li>
<li>Multiple income streams or complex business structure</li>
<li>Audited or received an IRS notice</li>
</ul>
<p><strong>What a CPA does:</strong></p>
<ul>
<li>Prepares and files your tax return</li>
<li>Advises on deductions and tax strategy</li>
<li>Helps with S-Corp election and payroll setup</li>
<li>Represents you if audited</li>
</ul>
<p><strong>Cost:</strong> $500-2,000/year for basic tax prep. More for complex situations or year-round advisory.</p>
<p><strong>How to find a good CPA:</strong></p>
<ul>
<li>Ask other solopreneurs for referrals</li>
<li>Look for CPAs who specialize in small business / self-employed</li>
<li>Interview 2-3 before choosing (ask about their experience with solopreneurs)</li>
</ul>
<p><strong>Red flags:</strong></p>
<ul>
<li>CPA who promises huge refunds or &quot;too-good-to-be-true&quot; deductions</li>
<li>CPA who doesn&#39;t ask detailed questions about your business</li>
<li>CPA who doesn&#39;t respond to emails/calls promptly</li>
</ul>
<p><strong>Rule:</strong> A good CPA pays for themselves in tax savings and peace of mind.</p>
<hr>
<h2>Tax Planning Mistakes to Avoid</h2>
<ul>
<li><strong>Not setting aside money for taxes.</strong> Tax bills hit hard in April if you haven&#39;t saved. Set aside 30% of every payment.</li>
<li><strong>Missing quarterly estimated tax payments.</strong> Underpayment penalties add up. Pay quarterly even if it&#39;s an estimate.</li>
<li><strong>Deducting personal expenses as business expenses.</strong> IRS audits this heavily. Only deduct legitimate business expenses.</li>
<li><strong>Not tracking mileage or receipts.</strong> If audited, you need proof. Track everything.</li>
<li><strong>Electing S-Corp too early.</strong> If profit &lt; $80K, S-Corp adds complexity without enough savings.</li>
<li><strong>Doing your own taxes when you shouldn&#39;t.</strong> Past $50K revenue, the risk of mistakes is too high. Hire a CPA.</li>
</ul>

                </div>
              </div>
            </article>
            <aside class="skill-page-sidebar">
              <div class="sidebar-card">
                <div class="sidebar-title">Actions</div>
                <a href="https://github.com/openclaw/skills/tree/main/skills/jk-0001/tax-planning/SKILL.md" target="_blank" rel="noopener" class="sidebar-btn sidebar-btn-primary">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
                  View on GitHub
                </a>
                <a href="https://clawdhub.com/jk-0001/tax-planning" target="_blank" rel="noopener" class="sidebar-btn sidebar-btn-clawdhub">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><line x1="2" y1="12" x2="22" y2="12"/></svg>
                  View on ClawdHub
                </a>
                <a href="https://raw.githubusercontent.com/openclaw/skills/main/skills/jk-0001/tax-planning/SKILL.md" download="SKILL.md" class="sidebar-btn sidebar-btn-secondary">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                  Download SKILL.md
                </a>
                <button onclick="sendToSecurityAuditor()" class="sidebar-btn sidebar-btn-security">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                  Security Check
                </button>
              </div>
              <div class="sidebar-card">
                <div class="sidebar-title">Details</div>
                <div class="sidebar-info">
                  <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Author</span>
                    <span class="sidebar-info-value">@jk-0001</span>
                  </div>
                  <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Category</span>
                    <span class="sidebar-info-value">DevOps & Cloud</span>
                  </div>
                </div>
              </div>
            </aside>
          </div>
        
  <footer class="footer">
    <div class="footer-inner">
      <p class="footer-text" style="margin-bottom: 8px;"><a href="https://github.com/neonone123/moltdirectory" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none;">View on GitHub</a></p>
      <p class="footer-text" style="opacity: 0.6; font-size: 13px;">OpenClawDirectory.com is a community-run project and is not affiliated with the official OpenClaw team or Peter Steinberger. We are just fans of the lobster.</p>
    </div>
  </footer>
  <script>
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      if (newTheme === 'light') {
        html.setAttribute('data-theme', 'light');
      } else {
        html.removeAttribute('data-theme');
      }
      localStorage.setItem('theme', newTheme);
    }
    
    function copySkillContent(btn) {
      const wrapper = btn.closest('.skill-source-wrapper');
      const content = wrapper.querySelector('.markdown-content');
      if (content) {
        const text = content.innerText || content.textContent;
        navigator.clipboard.writeText(text).then(() => {
          btn.classList.add('copied');
          btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> Copied!';
          setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy';
          }, 2000);
        });
      }
    }

    async function sendToSecurityAuditor() {
      try {
        const contentElement = document.querySelector('.markdown-content');
        if (!contentElement) throw new Error('Could not find markdown content');
        const skillContent = contentElement.innerText || contentElement.textContent;
        localStorage.setItem('skillAuditContent', skillContent);
        window.open('/security-auditor', '_blank'); 
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function updateVoteWidget(widget, toolData) {
      if (!widget || !toolData) return;
      const upBtn = widget.querySelector('[data-vote="1"]');
      const downBtn = widget.querySelector('[data-vote="-1"]');
      const countNode = widget.querySelector('.vote-count');
      widget.dataset.rankScore = String(toolData.rankScore ?? 0);
      widget.dataset.viewerVote = String(toolData.viewerVote ?? 0);

      if (countNode) {
        countNode.textContent = toolData.displayCount || 'New';
      }
      if (upBtn) {
        upBtn.classList.toggle('is-active', Number(toolData.viewerVote) === 1);
      }
      if (downBtn) {
        downBtn.classList.toggle('is-active', Number(toolData.viewerVote) === -1);
      }
    }

    function setWidgetBusy(widget, busy) {
      widget.dataset.busy = busy ? '1' : '0';
      widget.querySelectorAll('.vote-btn').forEach((btn) => {
        btn.disabled = busy;
      });
    }

    function applySortMode(grid, mode) {
      const cards = [...grid.querySelectorAll('.skill-card[data-tool-id]')];
      cards.sort((a, b) => {
        if (mode === 'community') {
          const scoreDiff = Number(b.dataset.rankScore || 0) - Number(a.dataset.rankScore || 0);
          if (scoreDiff !== 0) return scoreDiff;
        }
        return Number(a.dataset.originalIndex || 0) - Number(b.dataset.originalIndex || 0);
      });
      cards.forEach((card) => grid.appendChild(card));
    }

    function bindSortToggle(toolbar, grid) {
      const buttons = toolbar.querySelectorAll('.sort-toggle-btn');
      const status = toolbar.querySelector('.sort-status');
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const mode = btn.dataset.sortMode;
          buttons.forEach((b) => b.classList.toggle('is-active', b === btn));
          applySortMode(grid, mode);
          status.textContent = mode === 'community' ? 'Community ranking active' : 'Original order active';
        });
      });
    }

    async function fetchScores(categoryId, toolIds) {
      const params = new URLSearchParams({
        categoryId,
        toolIds: toolIds.join(',')
      });
      const response = await fetch('/api/v1/scores?' + params.toString(), {
        method: 'GET',
        credentials: 'same-origin'
      });
      if (!response.ok) {
        throw new Error('Unable to fetch vote scores');
      }
      return response.json();
    }

    async function submitVote(widget, voteValue) {
      const categoryId = widget.dataset.categoryId;
      const toolId = widget.dataset.toolId;
      setWidgetBusy(widget, true);
      try {
        const response = await fetch('/api/v1/vote', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            categoryId,
            toolId,
            vote: voteValue
          })
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload.error || 'Vote request failed');
        }
        if (payload.tool) {
          updateVoteWidget(widget, payload.tool);
          const card = widget.closest('.skill-card[data-tool-id]');
          if (card) {
            card.dataset.rankScore = String(payload.tool.rankScore ?? 0);
          }
        }
      } catch (error) {
        console.error(error);
      } finally {
        setWidgetBusy(widget, false);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const widgets = [...document.querySelectorAll('.vote-widget[data-category-id][data-tool-id]')];
      if (widgets.length === 0) return;

      const grouped = new Map();
      widgets.forEach((widget) => {
        const key = widget.dataset.categoryId;
        if (!grouped.has(key)) grouped.set(key, new Map());
        grouped.get(key).set(widget.dataset.toolId, widget);
      });

      for (const [categoryId, widgetMap] of grouped.entries()) {
        const toolIds = [...widgetMap.keys()];
        try {
          const data = await fetchScores(categoryId, toolIds);
          const byTool = new Map((data.tools || []).map((tool) => [tool.toolId, tool]));
          for (const [toolId, widget] of widgetMap.entries()) {
            const toolData = byTool.get(toolId);
            if (toolData) {
              updateVoteWidget(widget, toolData);
              const card = widget.closest('.skill-card[data-tool-id]');
              if (card) {
                card.dataset.rankScore = String(toolData.rankScore ?? 0);
              }
            }
          }
        } catch (error) {
          console.error(error);
        }
      }

      widgets.forEach((widget) => {
        widget.querySelectorAll('.vote-btn').forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            if (widget.dataset.busy === '1') return;
            const voteValue = Number(btn.dataset.vote);
            submitVote(widget, voteValue).then(() => {
              const grid = widget.closest('.skills-grid[data-category-id]');
              const toolbar = document.querySelector('.sort-toolbar[data-category-id="' + widget.dataset.categoryId + '"]');
              const communityBtn = toolbar ? toolbar.querySelector('.sort-toggle-btn[data-sort-mode="community"]') : null;
              if (grid && communityBtn && communityBtn.classList.contains('is-active')) {
                applySortMode(grid, 'community');
              }
            });
          });
        });
      });

      document.querySelectorAll('.skills-grid[data-category-id]').forEach((grid) => {
        const categoryId = grid.dataset.categoryId;
        const toolbar = document.querySelector('.sort-toolbar[data-category-id="' + categoryId + '"]');
        if (!toolbar) return;
        bindSortToggle(toolbar, grid);
        applySortMode(grid, 'community');
      });
    });
  </script>
</body>
</html>