<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ISO 13485 internal audit expertise for medical">
  <title>qms-audit-expert - OpenClaw Directory</title>
  <link rel="canonical" href="https://moltdirectory.com/health-fitness/qms-audit-expert/">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶û</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    // Apply saved theme before page renders to prevent flash
    (function() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      if (savedTheme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
      }
    })();
  </script>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo">

        <span class="logo-text">OpenClaw Directory</span>
      </a>
      <nav class="header-links">
        <a href="/start-here/" class="header-link">Start Here</a>
        <a href="/security-auditor" class="header-link">Security Auditor</a>
        <a href="https://github.com/neonone123/moltdirectory/issues/new?template=add-skill.yml" class="header-link" target="_blank" rel="noopener">Add Skill</a>
        <button class="theme-toggle" aria-label="Toggle theme" onclick="toggleTheme()">
          <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
        <a href="https://www.reddit.com/r/OpenClawDirectory/" class="header-link" target="_blank" rel="noopener" aria-label="Community">
          <svg viewBox="0 0 16 16" fill="currentColor" width="28" height="28"><path d="M6.167 8a.83.83 0 0 0-.83.83c0 .459.372.84.83.831a.831.831 0 0 0 0-1.661m1.843 3.647c.315 0 1.403-.038 1.976-.611a.23.23 0 0 0 0-.306.213.213 0 0 0-.306 0c-.353.363-1.126.487-1.67.487-.545 0-1.308-.124-1.671-.487a.213.213 0 0 0-.306 0 .213.213 0 0 0 0 .306c.564.563 1.652.61 1.977.61zm.992-2.807c0 .458.373.83.831.83s.83-.381.83-.83a.831.831 0 0 0-1.66 0z"/><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.828-1.165c-.315 0-.602.124-.812.325-.801-.573-1.9-.945-3.121-.993l.534-2.501 1.738.372a.83.83 0 1 0 .83-.869.83.83 0 0 0-.744.468l-1.938-.41a.2.2 0 0 0-.153.028.2.2 0 0 0-.086.134l-.592 2.788c-1.24.038-2.358.41-3.17.992-.21-.2-.496-.324-.81-.324a1.163 1.163 0 0 0-.478 2.224q-.03.17-.029.353c0 1.795 2.091 3.256 4.669 3.256s4.668-1.451 4.668-3.256c0-.114-.01-.238-.029-.353.401-.181.688-.592.688-1.069 0-.65-.525-1.165-1.165-1.165"/></svg>
        </a>
      </nav>
    </div>
  </header>
  
          <section class="skill-page-header">
            <div class="skill-page-header-inner">
              <a href="/health-fitness/" class="back-link">‚Üê Back to Health & Fitness</a>
              <div class="skill-page-meta">
                <a href="/health-fitness/" class="skill-page-category">Health & Fitness</a>
                <span class="skill-page-author">by @alirezarezvani</span>
              </div>
              <h1 class="skill-page-title">qms-audit-expert</h1>
              <p class="skill-page-desc">ISO 13485 internal audit expertise for medical</p>
              <div class="vote-widget skill-page-vote" data-category-id="health-fitness" data-tool-id="qms-audit-expert">
                <button type="button" class="vote-btn" data-vote="1" aria-label="Upvote qms-audit-expert">‚ñ≤</button>
                <span class="vote-count">New</span>
                <button type="button" class="vote-btn" data-vote="-1" aria-label="Downvote qms-audit-expert">‚ñº</button>
              </div>
            </div>
          </section>
          <div class="skill-page-body">
            <article class="skill-page-content">
              <div class="skill-source-wrapper">
                <div class="skill-source-header">
                  <div class="skill-source-title">Source Code</div>
                  <button class="copy-btn" onclick="copySkillContent(this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    Copy
                  </button>
                </div>
                <div class="markdown-content">
                  <h1>QMS Audit Expert</h1>
<p>ISO 13485 internal audit methodology for medical device quality management systems.</p>
<hr>
<h2>Table of Contents</h2>
<ul>
<li><a href="#audit-planning-workflow">Audit Planning Workflow</a></li>
<li><a href="#audit-execution">Audit Execution</a></li>
<li><a href="#nonconformity-management">Nonconformity Management</a></li>
<li><a href="#external-audit-preparation">External Audit Preparation</a></li>
<li><a href="#reference-documentation">Reference Documentation</a></li>
<li><a href="#tools">Tools</a></li>
</ul>
<hr>
<h2>Audit Planning Workflow</h2>
<p>Plan risk-based internal audit program:</p>
<ol>
<li>List all QMS processes requiring audit</li>
<li>Assign risk level to each process (High/Medium/Low)</li>
<li>Review previous audit findings and trends</li>
<li>Determine audit frequency by risk level</li>
<li>Assign qualified auditors (verify independence)</li>
<li>Create annual audit schedule</li>
<li>Communicate schedule to process owners</li>
<li><strong>Validation:</strong> All ISO 13485 clauses covered within cycle</li>
</ol>
<h3>Risk-Based Audit Frequency</h3>
<table>
<thead>
<tr>
<th>Risk Level</th>
<th>Frequency</th>
<th>Criteria</th>
</tr>
</thead>
<tbody><tr>
<td>High</td>
<td>Quarterly</td>
<td>Design control, CAPA, production validation</td>
</tr>
<tr>
<td>Medium</td>
<td>Semi-annual</td>
<td>Purchasing, training, document control</td>
</tr>
<tr>
<td>Low</td>
<td>Annual</td>
<td>Infrastructure, management review (if stable)</td>
</tr>
</tbody></table>
<h3>Audit Scope by Clause</h3>
<table>
<thead>
<tr>
<th>Clause</th>
<th>Process</th>
<th>Focus Areas</th>
</tr>
</thead>
<tbody><tr>
<td>4.2</td>
<td>Document Control</td>
<td>Document approval, distribution, obsolete control</td>
</tr>
<tr>
<td>5.6</td>
<td>Management Review</td>
<td>Inputs complete, decisions documented, actions tracked</td>
</tr>
<tr>
<td>6.2</td>
<td>Training</td>
<td>Competency defined, records complete, effectiveness verified</td>
</tr>
<tr>
<td>7.3</td>
<td>Design Control</td>
<td>Inputs, reviews, V&amp;V, transfer, changes</td>
</tr>
<tr>
<td>7.4</td>
<td>Purchasing</td>
<td>Supplier evaluation, incoming inspection</td>
</tr>
<tr>
<td>7.5</td>
<td>Production</td>
<td>Work instructions, process validation, DHR</td>
</tr>
<tr>
<td>7.6</td>
<td>Calibration</td>
<td>Equipment list, calibration status, out-of-tolerance</td>
</tr>
<tr>
<td>8.2.2</td>
<td>Internal Audit</td>
<td>Schedule compliance, auditor independence</td>
</tr>
<tr>
<td>8.3</td>
<td>NC Product</td>
<td>Identification, segregation, disposition</td>
</tr>
<tr>
<td>8.5</td>
<td>CAPA</td>
<td>Root cause, implementation, effectiveness</td>
</tr>
</tbody></table>
<h3>Auditor Independence</h3>
<p>Verify auditor independence before assignment:</p>
<ul>
<li><input disabled="" type="checkbox"> Auditor not responsible for area being audited</li>
<li><input disabled="" type="checkbox"> No direct reporting relationship to auditee</li>
<li><input disabled="" type="checkbox"> Not involved in recent activities under audit</li>
<li><input disabled="" type="checkbox"> Documented qualification for audit scope</li>
</ul>
<hr>
<h2>Audit Execution</h2>
<p>Conduct systematic internal audit:</p>
<ol>
<li>Prepare audit plan (scope, criteria, schedule)</li>
<li>Review relevant documentation before audit</li>
<li>Conduct opening meeting with auditee</li>
<li>Collect evidence (records, interviews, observation)</li>
<li>Classify findings (Major/Minor/Observation)</li>
<li>Conduct closing meeting with preliminary findings</li>
<li>Prepare audit report within 5 business days</li>
<li><strong>Validation:</strong> All scope items covered, findings supported by evidence</li>
</ol>
<h3>Evidence Collection</h3>
<table>
<thead>
<tr>
<th>Method</th>
<th>Use For</th>
<th>Documentation</th>
</tr>
</thead>
<tbody><tr>
<td>Document review</td>
<td>Procedures, records</td>
<td>Document number, version, date</td>
</tr>
<tr>
<td>Interview</td>
<td>Process understanding</td>
<td>Interviewee name, role, summary</td>
</tr>
<tr>
<td>Observation</td>
<td>Actual practice</td>
<td>What, where, when observed</td>
</tr>
<tr>
<td>Record trace</td>
<td>Process flow</td>
<td>Record IDs, dates, linkage</td>
</tr>
</tbody></table>
<h3>Audit Questions by Clause</h3>
<p><strong>Document Control (4.2):</strong></p>
<ul>
<li>Show me the document master list</li>
<li>How do you control obsolete documents?</li>
<li>Show me evidence of document change approval</li>
</ul>
<p><strong>Design Control (7.3):</strong></p>
<ul>
<li>Show me the Design History File for [product]</li>
<li>Who participates in design reviews?</li>
<li>Show me design input to output traceability</li>
</ul>
<p><strong>CAPA (8.5):</strong></p>
<ul>
<li>Show me the CAPA log with open items</li>
<li>How do you determine root cause?</li>
<li>Show me effectiveness verification records</li>
</ul>
<p>See <code>references/iso13485-audit-guide.md</code> for complete question sets.</p>
<h3>Finding Documentation</h3>
<p>Document each finding with:</p>
<pre><code>Requirement: [Specific ISO 13485 clause or procedure]
Evidence: [What was observed, reviewed, or heard]
Gap: [How evidence fails to meet requirement]
</code></pre>
<p><strong>Example:</strong></p>
<pre><code>Requirement: ISO 13485:2016 Clause 7.6 requires calibration
at specified intervals.

Evidence: Calibration records for pH meter (EQ-042) show
last calibration 2024-01-15. Calibration interval is
12 months. Today is 2025-03-20.

Gap: Equipment is 2 months overdue for calibration,
representing a gap in calibration program execution.
</code></pre>
<hr>
<h2>Nonconformity Management</h2>
<p>Classify and manage audit findings:</p>
<ol>
<li>Evaluate finding against classification criteria</li>
<li>Assign severity (Major/Minor/Observation)</li>
<li>Document finding with objective evidence</li>
<li>Communicate to process owner</li>
<li>Initiate CAPA for Major/Minor findings</li>
<li>Track to closure</li>
<li>Verify effectiveness at follow-up</li>
<li><strong>Validation:</strong> Finding closed only after effective CAPA</li>
</ol>
<h3>Classification Criteria</h3>
<table>
<thead>
<tr>
<th>Category</th>
<th>Definition</th>
<th>CAPA Required</th>
<th>Timeline</th>
</tr>
</thead>
<tbody><tr>
<td>Major</td>
<td>Systematic failure or absence of element</td>
<td>Yes</td>
<td>30 days</td>
</tr>
<tr>
<td>Minor</td>
<td>Isolated lapse or partial implementation</td>
<td>Recommended</td>
<td>60 days</td>
</tr>
<tr>
<td>Observation</td>
<td>Improvement opportunity</td>
<td>Optional</td>
<td>As appropriate</td>
</tr>
</tbody></table>
<h3>Classification Decision</h3>
<pre><code>Is required element absent or failed?
‚îú‚îÄ‚îÄ Yes ‚Üí Systematic (multiple instances)? ‚Üí MAJOR
‚îÇ   ‚îî‚îÄ‚îÄ No ‚Üí Could affect product safety? ‚Üí MAJOR
‚îÇ       ‚îî‚îÄ‚îÄ No ‚Üí MINOR
‚îî‚îÄ‚îÄ No ‚Üí Deviation from procedure?
    ‚îú‚îÄ‚îÄ Yes ‚Üí Recurring? ‚Üí MAJOR
    ‚îÇ   ‚îî‚îÄ‚îÄ No ‚Üí MINOR
    ‚îî‚îÄ‚îÄ No ‚Üí Improvement opportunity? ‚Üí OBSERVATION
</code></pre>
<h3>CAPA Integration</h3>
<table>
<thead>
<tr>
<th>Finding Severity</th>
<th>CAPA Depth</th>
<th>Verification</th>
</tr>
</thead>
<tbody><tr>
<td>Major</td>
<td>Full root cause analysis (5-Why, Fishbone)</td>
<td>Next audit or within 6 months</td>
</tr>
<tr>
<td>Minor</td>
<td>Immediate cause identification</td>
<td>Next scheduled audit</td>
</tr>
<tr>
<td>Observation</td>
<td>Not required</td>
<td>Noted at next audit</td>
</tr>
</tbody></table>
<p>See <code>references/nonconformity-classification.md</code> for detailed guidance.</p>
<hr>
<h2>External Audit Preparation</h2>
<p>Prepare for certification body or regulatory audit:</p>
<ol>
<li>Complete all scheduled internal audits</li>
<li>Verify all findings closed with effective CAPA</li>
<li>Review documentation for currency and accuracy</li>
<li>Conduct management review with audit as input</li>
<li>Prepare facility and personnel</li>
<li>Conduct mock audit (full scope)</li>
<li>Brief personnel on audit protocol</li>
<li><strong>Validation:</strong> Mock audit findings addressed before external audit</li>
</ol>
<h3>Pre-Audit Readiness Checklist</h3>
<p><strong>Documentation:</strong></p>
<ul>
<li><input disabled="" type="checkbox"> Quality Manual current</li>
<li><input disabled="" type="checkbox"> Procedures reflect actual practice</li>
<li><input disabled="" type="checkbox"> Records complete and retrievable</li>
<li><input disabled="" type="checkbox"> Previous audit findings closed</li>
</ul>
<p><strong>Personnel:</strong></p>
<ul>
<li><input disabled="" type="checkbox"> Key personnel available during audit</li>
<li><input disabled="" type="checkbox"> Subject matter experts identified</li>
<li><input disabled="" type="checkbox"> Personnel briefed on audit protocol</li>
<li><input disabled="" type="checkbox"> Escorts assigned</li>
</ul>
<p><strong>Facility:</strong></p>
<ul>
<li><input disabled="" type="checkbox"> Work areas organized</li>
<li><input disabled="" type="checkbox"> Documents at point of use current</li>
<li><input disabled="" type="checkbox"> Equipment calibration status visible</li>
<li><input disabled="" type="checkbox"> Nonconforming product segregated</li>
</ul>
<h3>Mock Audit Protocol</h3>
<ol>
<li>Use external auditor or qualified internal auditor</li>
<li>Cover full scope of upcoming external audit</li>
<li>Simulate actual audit conditions (timing, formality)</li>
<li>Document findings as for real audit</li>
<li>Address all Major and Minor findings before external audit</li>
<li>Brief management on readiness status</li>
</ol>
<hr>
<h2>Reference Documentation</h2>
<h3>ISO 13485 Audit Guide</h3>
<p><code>references/iso13485-audit-guide.md</code> contains:</p>
<ul>
<li>Clause-by-clause audit methodology</li>
<li>Sample audit questions for each clause</li>
<li>Evidence collection requirements</li>
<li>Common nonconformities by clause</li>
<li>Finding severity classification</li>
</ul>
<h3>Nonconformity Classification</h3>
<p><code>references/nonconformity-classification.md</code> contains:</p>
<ul>
<li>Severity classification criteria and decision tree</li>
<li>Impact vs. occurrence matrix</li>
<li>CAPA integration requirements</li>
<li>Finding documentation templates</li>
<li>Closure requirements by severity</li>
</ul>
<hr>
<h2>Tools</h2>
<h3>Audit Schedule Optimizer</h3>
<pre><code class="language-bash"># Generate optimized audit schedule
python scripts/audit_schedule_optimizer.py --processes processes.json

# Interactive mode
python scripts/audit_schedule_optimizer.py --interactive

# JSON output for integration
python scripts/audit_schedule_optimizer.py --processes processes.json --output json
</code></pre>
<p>Generates risk-based audit schedule considering:</p>
<ul>
<li>Process risk level</li>
<li>Previous findings</li>
<li>Days since last audit</li>
<li>Criticality scores</li>
</ul>
<p><strong>Output includes:</strong></p>
<ul>
<li>Prioritized audit schedule</li>
<li>Quarterly distribution</li>
<li>Overdue audit alerts</li>
<li>Resource recommendations</li>
</ul>
<h3>Sample Process Input</h3>
<pre><code class="language-json">{
  &quot;processes&quot;: [
    {
      &quot;name&quot;: &quot;Design Control&quot;,
      &quot;iso_clause&quot;: &quot;7.3&quot;,
      &quot;risk_level&quot;: &quot;HIGH&quot;,
      &quot;last_audit_date&quot;: &quot;2024-06-15&quot;,
      &quot;previous_findings&quot;: 2
    },
    {
      &quot;name&quot;: &quot;Document Control&quot;,
      &quot;iso_clause&quot;: &quot;4.2&quot;,
      &quot;risk_level&quot;: &quot;MEDIUM&quot;,
      &quot;last_audit_date&quot;: &quot;2024-09-01&quot;,
      &quot;previous_findings&quot;: 0
    }
  ]
}
</code></pre>
<hr>
<h2>Audit Program Metrics</h2>
<p>Track audit program effectiveness:</p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Measurement</th>
</tr>
</thead>
<tbody><tr>
<td>Schedule compliance</td>
<td>&gt;90%</td>
<td>Audits completed on time</td>
</tr>
<tr>
<td>Finding closure rate</td>
<td>&gt;95%</td>
<td>Findings closed by due date</td>
</tr>
<tr>
<td>Repeat findings</td>
<td>&lt;10%</td>
<td>Same finding in consecutive audits</td>
</tr>
<tr>
<td>CAPA effectiveness</td>
<td>&gt;90%</td>
<td>Verified effective at follow-up</td>
</tr>
<tr>
<td>Auditor utilization</td>
<td>4 days/month</td>
<td>Audit days per qualified auditor</td>
</tr>
</tbody></table>

                </div>
              </div>
            </article>
            <aside class="skill-page-sidebar">
              <div class="sidebar-card">
                <div class="sidebar-title">Actions</div>
                <a href="https://github.com/openclaw/skills/tree/main/skills/alirezarezvani/qms-audit-expert/SKILL.md" target="_blank" rel="noopener" class="sidebar-btn sidebar-btn-primary">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
                  View on GitHub
                </a>
                <a href="https://clawdhub.com/alirezarezvani/qms-audit-expert" target="_blank" rel="noopener" class="sidebar-btn sidebar-btn-clawdhub">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><line x1="2" y1="12" x2="22" y2="12"/></svg>
                  View on ClawdHub
                </a>
                <a href="https://raw.githubusercontent.com/openclaw/skills/main/skills/alirezarezvani/qms-audit-expert/SKILL.md" download="SKILL.md" class="sidebar-btn sidebar-btn-secondary">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                  Download SKILL.md
                </a>
                <button onclick="sendToSecurityAuditor()" class="sidebar-btn sidebar-btn-security">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                  Security Check
                </button>
              </div>
              <div class="sidebar-card">
                <div class="sidebar-title">Details</div>
                <div class="sidebar-info">
                  <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Author</span>
                    <span class="sidebar-info-value">@alirezarezvani</span>
                  </div>
                  <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Category</span>
                    <span class="sidebar-info-value">Health & Fitness</span>
                  </div>
                </div>
              </div>
            </aside>
          </div>
        
  <footer class="footer">
    <div class="footer-inner">
      <p class="footer-text" style="margin-bottom: 8px;"><a href="https://github.com/neonone123/moltdirectory" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none;">View on GitHub</a></p>
      <p class="footer-text" style="opacity: 0.6; font-size: 13px;">OpenClawDirectory.com is a community-run project and is not affiliated with the official OpenClaw team or Peter Steinberger. We are just fans of the lobster.</p>
    </div>
  </footer>
  <script>
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      if (newTheme === 'light') {
        html.setAttribute('data-theme', 'light');
      } else {
        html.removeAttribute('data-theme');
      }
      localStorage.setItem('theme', newTheme);
    }
    
    function copySkillContent(btn) {
      const wrapper = btn.closest('.skill-source-wrapper');
      const content = wrapper.querySelector('.markdown-content');
      if (content) {
        const text = content.innerText || content.textContent;
        navigator.clipboard.writeText(text).then(() => {
          btn.classList.add('copied');
          btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> Copied!';
          setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy';
          }, 2000);
        });
      }
    }

    async function sendToSecurityAuditor() {
      try {
        const contentElement = document.querySelector('.markdown-content');
        if (!contentElement) throw new Error('Could not find markdown content');
        const skillContent = contentElement.innerText || contentElement.textContent;
        localStorage.setItem('skillAuditContent', skillContent);
        window.open('/security-auditor', '_blank'); 
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function updateVoteWidget(widget, toolData) {
      if (!widget || !toolData) return;
      const upBtn = widget.querySelector('[data-vote="1"]');
      const downBtn = widget.querySelector('[data-vote="-1"]');
      const countNode = widget.querySelector('.vote-count');
      widget.dataset.rankScore = String(toolData.rankScore ?? 0);
      widget.dataset.viewerVote = String(toolData.viewerVote ?? 0);

      if (countNode) {
        countNode.textContent = toolData.displayCount || 'New';
      }
      if (upBtn) {
        upBtn.classList.toggle('is-active', Number(toolData.viewerVote) === 1);
      }
      if (downBtn) {
        downBtn.classList.toggle('is-active', Number(toolData.viewerVote) === -1);
      }
    }

    function setWidgetBusy(widget, busy) {
      widget.dataset.busy = busy ? '1' : '0';
      widget.querySelectorAll('.vote-btn').forEach((btn) => {
        btn.disabled = busy;
      });
    }

    function applySortMode(grid, mode) {
      const cards = [...grid.querySelectorAll('.skill-card[data-tool-id]')];
      cards.sort((a, b) => {
        if (mode === 'community') {
          const scoreDiff = Number(b.dataset.rankScore || 0) - Number(a.dataset.rankScore || 0);
          if (scoreDiff !== 0) return scoreDiff;
        }
        return Number(a.dataset.originalIndex || 0) - Number(b.dataset.originalIndex || 0);
      });
      cards.forEach((card) => grid.appendChild(card));
    }

    function bindSortToggle(toolbar, grid) {
      const buttons = toolbar.querySelectorAll('.sort-toggle-btn');
      const status = toolbar.querySelector('.sort-status');
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const mode = btn.dataset.sortMode;
          buttons.forEach((b) => b.classList.toggle('is-active', b === btn));
          applySortMode(grid, mode);
          status.textContent = mode === 'community' ? 'Community ranking active' : 'Original order active';
        });
      });
    }

    async function fetchScores(categoryId, toolIds) {
      const params = new URLSearchParams({
        categoryId,
        toolIds: toolIds.join(',')
      });
      const response = await fetch('/api/v1/scores?' + params.toString(), {
        method: 'GET',
        credentials: 'same-origin'
      });
      if (!response.ok) {
        throw new Error('Unable to fetch vote scores');
      }
      return response.json();
    }

    async function submitVote(widget, voteValue) {
      const categoryId = widget.dataset.categoryId;
      const toolId = widget.dataset.toolId;
      setWidgetBusy(widget, true);
      try {
        const response = await fetch('/api/v1/vote', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            categoryId,
            toolId,
            vote: voteValue
          })
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload.error || 'Vote request failed');
        }
        if (payload.tool) {
          updateVoteWidget(widget, payload.tool);
          const card = widget.closest('.skill-card[data-tool-id]');
          if (card) {
            card.dataset.rankScore = String(payload.tool.rankScore ?? 0);
          }
        }
      } catch (error) {
        console.error(error);
      } finally {
        setWidgetBusy(widget, false);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const widgets = [...document.querySelectorAll('.vote-widget[data-category-id][data-tool-id]')];
      if (widgets.length === 0) return;

      const grouped = new Map();
      widgets.forEach((widget) => {
        const key = widget.dataset.categoryId;
        if (!grouped.has(key)) grouped.set(key, new Map());
        grouped.get(key).set(widget.dataset.toolId, widget);
      });

      for (const [categoryId, widgetMap] of grouped.entries()) {
        const toolIds = [...widgetMap.keys()];
        try {
          const data = await fetchScores(categoryId, toolIds);
          const byTool = new Map((data.tools || []).map((tool) => [tool.toolId, tool]));
          for (const [toolId, widget] of widgetMap.entries()) {
            const toolData = byTool.get(toolId);
            if (toolData) {
              updateVoteWidget(widget, toolData);
              const card = widget.closest('.skill-card[data-tool-id]');
              if (card) {
                card.dataset.rankScore = String(toolData.rankScore ?? 0);
              }
            }
          }
        } catch (error) {
          console.error(error);
        }
      }

      widgets.forEach((widget) => {
        widget.querySelectorAll('.vote-btn').forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            if (widget.dataset.busy === '1') return;
            const voteValue = Number(btn.dataset.vote);
            submitVote(widget, voteValue).then(() => {
              const grid = widget.closest('.skills-grid[data-category-id]');
              const toolbar = document.querySelector('.sort-toolbar[data-category-id="' + widget.dataset.categoryId + '"]');
              const communityBtn = toolbar ? toolbar.querySelector('.sort-toggle-btn[data-sort-mode="community"]') : null;
              if (grid && communityBtn && communityBtn.classList.contains('is-active')) {
                applySortMode(grid, 'community');
              }
            });
          });
        });
      });

      document.querySelectorAll('.skills-grid[data-category-id]').forEach((grid) => {
        const categoryId = grid.dataset.categoryId;
        const toolbar = document.querySelector('.sort-toolbar[data-category-id="' + categoryId + '"]');
        if (!toolbar) return;
        bindSortToggle(toolbar, grid);
        applySortMode(grid, 'community');
      });
    });
  </script>
</body>
</html>