<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Generate material">
  <title>cwicr-material-procurement - OpenClaw Directory</title>
  <link rel="canonical" href="https://moltdirectory.com/ai-llms/cwicr-material-procurement/">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶û</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    // Apply saved theme before page renders to prevent flash
    (function() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      if (savedTheme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
      }
    })();
  </script>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo">

        <span class="logo-text">OpenClaw Directory</span>
      </a>
      <nav class="header-links">
        <a href="/start-here/" class="header-link">Start Here</a>
        <a href="/security-auditor" class="header-link">Security Auditor</a>
        <a href="https://github.com/neonone123/moltdirectory/issues/new?template=add-skill.yml" class="header-link" target="_blank" rel="noopener">Add Skill</a>
        <button class="theme-toggle" aria-label="Toggle theme" onclick="toggleTheme()">
          <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
        <a href="https://www.reddit.com/r/OpenClawDirectory/" class="header-link" target="_blank" rel="noopener" aria-label="Community">
          <svg viewBox="0 0 16 16" fill="currentColor" width="28" height="28"><path d="M6.167 8a.83.83 0 0 0-.83.83c0 .459.372.84.83.831a.831.831 0 0 0 0-1.661m1.843 3.647c.315 0 1.403-.038 1.976-.611a.23.23 0 0 0 0-.306.213.213 0 0 0-.306 0c-.353.363-1.126.487-1.67.487-.545 0-1.308-.124-1.671-.487a.213.213 0 0 0-.306 0 .213.213 0 0 0 0 .306c.564.563 1.652.61 1.977.61zm.992-2.807c0 .458.373.83.831.83s.83-.381.83-.83a.831.831 0 0 0-1.66 0z"/><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.828-1.165c-.315 0-.602.124-.812.325-.801-.573-1.9-.945-3.121-.993l.534-2.501 1.738.372a.83.83 0 1 0 .83-.869.83.83 0 0 0-.744.468l-1.938-.41a.2.2 0 0 0-.153.028.2.2 0 0 0-.086.134l-.592 2.788c-1.24.038-2.358.41-3.17.992-.21-.2-.496-.324-.81-.324a1.163 1.163 0 0 0-.478 2.224q-.03.17-.029.353c0 1.795 2.091 3.256 4.669 3.256s4.668-1.451 4.668-3.256c0-.114-.01-.238-.029-.353.401-.181.688-.592.688-1.069 0-.65-.525-1.165-1.165-1.165"/></svg>
        </a>
      </nav>
    </div>
  </header>
  
          <section class="skill-page-header">
            <div class="skill-page-header-inner">
              <a href="/ai-llms/" class="back-link">‚Üê Back to AI & LLMs</a>
              <div class="skill-page-meta">
                <a href="/ai-llms/" class="skill-page-category">AI & LLMs</a>
                <span class="skill-page-author">by @datadrivenconstruction</span>
              </div>
              <h1 class="skill-page-title">cwicr-material-procurement</h1>
              <p class="skill-page-desc">Generate material</p>
              <div class="vote-widget skill-page-vote" data-category-id="ai-llms" data-tool-id="cwicr-material-procurement">
                <button type="button" class="vote-btn" data-vote="1" aria-label="Upvote cwicr-material-procurement">‚ñ≤</button>
                <span class="vote-count">New</span>
                <button type="button" class="vote-btn" data-vote="-1" aria-label="Downvote cwicr-material-procurement">‚ñº</button>
              </div>
            </div>
          </section>
          <div class="skill-page-body">
            <article class="skill-page-content">
              <div class="skill-source-wrapper">
                <div class="skill-source-header">
                  <div class="skill-source-title">Source Code</div>
                  <button class="copy-btn" onclick="copySkillContent(this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    Copy
                  </button>
                </div>
                <div class="markdown-content">
                  <h1>CWICR Material Procurement</h1>
<h2>Business Case</h2>
<h3>Problem Statement</h3>
<p>Material procurement needs accurate quantity lists:</p>
<ul>
<li>What materials are needed?</li>
<li>How much of each with waste allowance?</li>
<li>When are they needed on site?</li>
<li>How to group for suppliers?</li>
</ul>
<h3>Solution</h3>
<p>Generate procurement lists from CWICR material data with waste factors, delivery scheduling, and supplier grouping.</p>
<h3>Business Value</h3>
<ul>
<li><strong>Accurate quantities</strong> - Based on validated norms</li>
<li><strong>Waste included</strong> - Industry-standard waste factors</li>
<li><strong>Timely delivery</strong> - Aligned with schedule</li>
<li><strong>Cost optimization</strong> - Bulk ordering opportunities</li>
</ul>
<h2>Technical Implementation</h2>
<pre><code class="language-python">import pandas as pd
import numpy as np
from typing import Dict, Any, List, Optional, Tuple
from dataclasses import dataclass, field
from datetime import datetime, timedelta
from enum import Enum
from collections import defaultdict


class MaterialCategory(Enum):
    &quot;&quot;&quot;Material categories for procurement.&quot;&quot;&quot;
    CONCRETE = &quot;concrete&quot;
    STEEL = &quot;steel&quot;
    TIMBER = &quot;timber&quot;
    MASONRY = &quot;masonry&quot;
    FINISHES = &quot;finishes&quot;
    MEP = &quot;mep&quot;
    INSULATION = &quot;insulation&quot;
    ROOFING = &quot;roofing&quot;
    EARTHWORK = &quot;earthwork&quot;
    OTHER = &quot;other&quot;


class ProcurementPriority(Enum):
    &quot;&quot;&quot;Procurement priority levels.&quot;&quot;&quot;
    CRITICAL = 1
    HIGH = 2
    MEDIUM = 3
    LOW = 4


@dataclass
class MaterialItem:
    &quot;&quot;&quot;Single material item for procurement.&quot;&quot;&quot;
    material_code: str
    description: str
    category: MaterialCategory
    unit: str
    net_quantity: float
    waste_factor: float
    gross_quantity: float
    unit_price: float
    total_cost: float
    lead_time_days: int
    required_date: datetime
    order_date: datetime
    supplier: str = &quot;&quot;
    work_item_codes: List[str] = field(default_factory=list)


@dataclass
class ProcurementList:
    &quot;&quot;&quot;Complete procurement list.&quot;&quot;&quot;
    project_name: str
    generated_date: datetime
    total_items: int
    total_cost: float
    items: List[MaterialItem]
    by_category: Dict[str, float]
    by_supplier: Dict[str, List[MaterialItem]]


# Standard waste factors by material type
WASTE_FACTORS = {
    &#39;concrete&#39;: 0.05,      # 5%
    &#39;reinforcement&#39;: 0.03, # 3%
    &#39;formwork&#39;: 0.10,      # 10%
    &#39;masonry&#39;: 0.05,       # 5%
    &#39;timber&#39;: 0.08,        # 8%
    &#39;drywall&#39;: 0.10,       # 10%
    &#39;tiles&#39;: 0.10,         # 10%
    &#39;paint&#39;: 0.05,         # 5%
    &#39;insulation&#39;: 0.05,    # 5%
    &#39;pipes&#39;: 0.03,         # 3%
    &#39;cables&#39;: 0.05,        # 5%
    &#39;default&#39;: 0.05        # 5%
}

# Standard lead times by category (days)
LEAD_TIMES = {
    &#39;concrete&#39;: 1,         # Ready-mix
    &#39;reinforcement&#39;: 7,    # Steel delivery
    &#39;formwork&#39;: 3,         # Standard forms
    &#39;masonry&#39;: 5,          # Block delivery
    &#39;timber&#39;: 5,           # Lumber
    &#39;structural_steel&#39;: 21, # Fabrication
    &#39;windows&#39;: 28,         # Manufacturing
    &#39;doors&#39;: 14,           # Standard doors
    &#39;mep&#39;: 14,             # MEP equipment
    &#39;finishes&#39;: 7,         # Standard finishes
    &#39;default&#39;: 7
}


class CWICRMaterialProcurement:
    &quot;&quot;&quot;Generate procurement lists from CWICR data.&quot;&quot;&quot;

    def __init__(self, cwicr_data: pd.DataFrame,
                 resources_data: pd.DataFrame = None):
        self.work_items = cwicr_data
        self.resources = resources_data
        self._index_data()

    def _index_data(self):
        &quot;&quot;&quot;Index data for fast lookup.&quot;&quot;&quot;
        if &#39;work_item_code&#39; in self.work_items.columns:
            self._work_index = self.work_items.set_index(&#39;work_item_code&#39;)
        else:
            self._work_index = None

    def get_waste_factor(self, material_type: str) -&gt; float:
        &quot;&quot;&quot;Get waste factor for material type.&quot;&quot;&quot;
        material_lower = str(material_type).lower()
        for key, factor in WASTE_FACTORS.items():
            if key in material_lower:
                return factor
        return WASTE_FACTORS[&#39;default&#39;]

    def get_lead_time(self, material_type: str) -&gt; int:
        &quot;&quot;&quot;Get lead time for material type.&quot;&quot;&quot;
        material_lower = str(material_type).lower()
        for key, days in LEAD_TIMES.items():
            if key in material_lower:
                return days
        return LEAD_TIMES[&#39;default&#39;]

    def get_category(self, material_type: str) -&gt; MaterialCategory:
        &quot;&quot;&quot;Determine material category.&quot;&quot;&quot;
        material_lower = str(material_type).lower()

        category_mapping = {
            &#39;concrete&#39;: MaterialCategory.CONCRETE,
            &#39;cement&#39;: MaterialCategory.CONCRETE,
            &#39;steel&#39;: MaterialCategory.STEEL,
            &#39;rebar&#39;: MaterialCategory.STEEL,
            &#39;reinforcement&#39;: MaterialCategory.STEEL,
            &#39;timber&#39;: MaterialCategory.TIMBER,
            &#39;wood&#39;: MaterialCategory.TIMBER,
            &#39;lumber&#39;: MaterialCategory.TIMBER,
            &#39;masonry&#39;: MaterialCategory.MASONRY,
            &#39;block&#39;: MaterialCategory.MASONRY,
            &#39;brick&#39;: MaterialCategory.MASONRY,
            &#39;paint&#39;: MaterialCategory.FINISHES,
            &#39;tile&#39;: MaterialCategory.FINISHES,
            &#39;floor&#39;: MaterialCategory.FINISHES,
            &#39;electrical&#39;: MaterialCategory.MEP,
            &#39;plumbing&#39;: MaterialCategory.MEP,
            &#39;hvac&#39;: MaterialCategory.MEP,
            &#39;insulation&#39;: MaterialCategory.INSULATION,
            &#39;roof&#39;: MaterialCategory.ROOFING
        }

        for key, cat in category_mapping.items():
            if key in material_lower:
                return cat
        return MaterialCategory.OTHER

    def extract_materials(self,
                         items: List[Dict[str, Any]],
                         schedule: Dict[str, datetime] = None) -&gt; List[MaterialItem]:
        &quot;&quot;&quot;Extract material requirements from work items.&quot;&quot;&quot;

        materials = defaultdict(lambda: {
            &#39;net_quantity&#39;: 0,
            &#39;work_items&#39;: [],
            &#39;required_date&#39;: None
        })

        for item in items:
            code = item.get(&#39;work_item_code&#39;, item.get(&#39;code&#39;))
            qty = item.get(&#39;quantity&#39;, 0)
            required_date = item.get(&#39;required_date&#39;)

            if self._work_index is not None and code in self._work_index.index:
                work_item = self._work_index.loc[code]

                # Get material info from work item
                material_desc = str(work_item.get(&#39;material_description&#39;,
                                                   work_item.get(&#39;description&#39;, &#39;&#39;)))
                material_unit = str(work_item.get(&#39;material_unit&#39;,
                                                   work_item.get(&#39;unit&#39;, &#39;&#39;)))
                material_norm = float(work_item.get(&#39;material_norm&#39;, 1) or 1)
                material_cost = float(work_item.get(&#39;material_cost&#39;, 0) or 0)

                # Calculate material quantity
                material_qty = qty * material_norm

                # Aggregate by material description
                mat_key = f&quot;{material_desc}|{material_unit}&quot;
                materials[mat_key][&#39;net_quantity&#39;] += material_qty
                materials[mat_key][&#39;work_items&#39;].append(code)
                materials[mat_key][&#39;description&#39;] = material_desc
                materials[mat_key][&#39;unit&#39;] = material_unit
                materials[mat_key][&#39;unit_price&#39;] = material_cost / material_norm if material_norm &gt; 0 else 0

                if required_date:
                    if materials[mat_key][&#39;required_date&#39;] is None:
                        materials[mat_key][&#39;required_date&#39;] = required_date
                    else:
                        materials[mat_key][&#39;required_date&#39;] = min(
                            materials[mat_key][&#39;required_date&#39;], required_date
                        )

        # Convert to MaterialItem list
        result = []
        for mat_key, data in materials.items():
            description = data[&#39;description&#39;]
            waste_factor = self.get_waste_factor(description)
            lead_time = self.get_lead_time(description)
            net_qty = data[&#39;net_quantity&#39;]
            gross_qty = net_qty * (1 + waste_factor)
            unit_price = data.get(&#39;unit_price&#39;, 0)

            required_date = data[&#39;required_date&#39;] or datetime.now() + timedelta(days=30)
            order_date = required_date - timedelta(days=lead_time)

            result.append(MaterialItem(
                material_code=mat_key.split(&#39;|&#39;)[0][:20],
                description=description,
                category=self.get_category(description),
                unit=data[&#39;unit&#39;],
                net_quantity=round(net_qty, 2),
                waste_factor=waste_factor,
                gross_quantity=round(gross_qty, 2),
                unit_price=round(unit_price, 2),
                total_cost=round(gross_qty * unit_price, 2),
                lead_time_days=lead_time,
                required_date=required_date,
                order_date=order_date,
                work_item_codes=data[&#39;work_items&#39;]
            ))

        return result

    def generate_procurement_list(self,
                                  items: List[Dict[str, Any]],
                                  project_name: str = &quot;Project&quot;) -&gt; ProcurementList:
        &quot;&quot;&quot;Generate complete procurement list.&quot;&quot;&quot;

        materials = self.extract_materials(items)

        # Group by category
        by_category = defaultdict(float)
        for mat in materials:
            by_category[mat.category.value] += mat.total_cost

        # Group by supplier (placeholder - would use supplier mapping)
        by_supplier = defaultdict(list)
        for mat in materials:
            supplier = self._suggest_supplier(mat)
            mat.supplier = supplier
            by_supplier[supplier].append(mat)

        return ProcurementList(
            project_name=project_name,
            generated_date=datetime.now(),
            total_items=len(materials),
            total_cost=sum(m.total_cost for m in materials),
            items=materials,
            by_category=dict(by_category),
            by_supplier=dict(by_supplier)
        )

    def _suggest_supplier(self, material: MaterialItem) -&gt; str:
        &quot;&quot;&quot;Suggest supplier based on material category.&quot;&quot;&quot;
        supplier_mapping = {
            MaterialCategory.CONCRETE: &quot;Ready-Mix Supplier&quot;,
            MaterialCategory.STEEL: &quot;Steel Fabricator&quot;,
            MaterialCategory.TIMBER: &quot;Lumber Yard&quot;,
            MaterialCategory.MASONRY: &quot;Masonry Supplier&quot;,
            MaterialCategory.MEP: &quot;MEP Distributor&quot;,
            MaterialCategory.FINISHES: &quot;Building Materials&quot;,
            MaterialCategory.INSULATION: &quot;Insulation Supplier&quot;,
            MaterialCategory.ROOFING: &quot;Roofing Supplier&quot;
        }
        return supplier_mapping.get(material.category, &quot;General Supplier&quot;)

    def create_purchase_order(self,
                              materials: List[MaterialItem],
                              supplier: str,
                              po_number: str) -&gt; Dict[str, Any]:
        &quot;&quot;&quot;Create purchase order for supplier.&quot;&quot;&quot;

        po_items = [m for m in materials if m.supplier == supplier]

        return {
            &#39;po_number&#39;: po_number,
            &#39;supplier&#39;: supplier,
            &#39;date&#39;: datetime.now().isoformat(),
            &#39;delivery_date&#39;: min(m.required_date for m in po_items).isoformat() if po_items else None,
            &#39;items&#39;: [
                {
                    &#39;description&#39;: m.description,
                    &#39;quantity&#39;: m.gross_quantity,
                    &#39;unit&#39;: m.unit,
                    &#39;unit_price&#39;: m.unit_price,
                    &#39;total&#39;: m.total_cost
                }
                for m in po_items
            ],
            &#39;subtotal&#39;: sum(m.total_cost for m in po_items),
            &#39;item_count&#39;: len(po_items)
        }

    def export_to_excel(self,
                       procurement_list: ProcurementList,
                       output_path: str) -&gt; str:
        &quot;&quot;&quot;Export procurement list to Excel.&quot;&quot;&quot;

        with pd.ExcelWriter(output_path, engine=&#39;openpyxl&#39;) as writer:
            # All materials
            items_df = pd.DataFrame([
                {
                    &#39;Description&#39;: m.description,
                    &#39;Category&#39;: m.category.value,
                    &#39;Unit&#39;: m.unit,
                    &#39;Net Qty&#39;: m.net_quantity,
                    &#39;Waste %&#39;: m.waste_factor * 100,
                    &#39;Gross Qty&#39;: m.gross_quantity,
                    &#39;Unit Price&#39;: m.unit_price,
                    &#39;Total Cost&#39;: m.total_cost,
                    &#39;Lead Time&#39;: m.lead_time_days,
                    &#39;Order By&#39;: m.order_date.strftime(&#39;%Y-%m-%d&#39;),
                    &#39;Required&#39;: m.required_date.strftime(&#39;%Y-%m-%d&#39;),
                    &#39;Supplier&#39;: m.supplier
                }
                for m in procurement_list.items
            ])
            items_df.to_excel(writer, sheet_name=&#39;Materials&#39;, index=False)

            # By category
            cat_df = pd.DataFrame([
                {&#39;Category&#39;: cat, &#39;Total Cost&#39;: cost}
                for cat, cost in procurement_list.by_category.items()
            ])
            cat_df.to_excel(writer, sheet_name=&#39;By Category&#39;, index=False)

            # Summary
            summary_df = pd.DataFrame([{
                &#39;Project&#39;: procurement_list.project_name,
                &#39;Generated&#39;: procurement_list.generated_date.strftime(&#39;%Y-%m-%d&#39;),
                &#39;Total Items&#39;: procurement_list.total_items,
                &#39;Total Cost&#39;: procurement_list.total_cost
            }])
            summary_df.to_excel(writer, sheet_name=&#39;Summary&#39;, index=False)

        return output_path

    def get_critical_orders(self,
                           procurement_list: ProcurementList,
                           days_ahead: int = 14) -&gt; List[MaterialItem]:
        &quot;&quot;&quot;Get materials that need to be ordered soon.&quot;&quot;&quot;

        cutoff = datetime.now() + timedelta(days=days_ahead)
        return [
            m for m in procurement_list.items
            if m.order_date &lt;= cutoff
        ]

    def aggregate_by_material(self,
                              items: List[Dict[str, Any]]) -&gt; pd.DataFrame:
        &quot;&quot;&quot;Aggregate materials across multiple work items.&quot;&quot;&quot;

        materials = self.extract_materials(items)

        df = pd.DataFrame([
            {
                &#39;Material&#39;: m.description,
                &#39;Category&#39;: m.category.value,
                &#39;Total Qty&#39;: m.gross_quantity,
                &#39;Unit&#39;: m.unit,
                &#39;Total Cost&#39;: m.total_cost,
                &#39;Work Items&#39;: len(m.work_item_codes)
            }
            for m in materials
        ])

        return df.sort_values(&#39;Total Cost&#39;, ascending=False)
</code></pre>
<h2>Quick Start</h2>
<pre><code class="language-python"># Load CWICR data
cwicr = pd.read_parquet(&quot;ddc_cwicr_en.parquet&quot;)

# Initialize procurement generator
procurement = CWICRMaterialProcurement(cwicr)

# Define work items
items = [
    {&#39;work_item_code&#39;: &#39;CONC-001&#39;, &#39;quantity&#39;: 150},
    {&#39;work_item_code&#39;: &#39;REBAR-002&#39;, &#39;quantity&#39;: 5000},
    {&#39;work_item_code&#39;: &#39;FORM-003&#39;, &#39;quantity&#39;: 300}
]

# Generate procurement list
proc_list = procurement.generate_procurement_list(items, &quot;Building A&quot;)

print(f&quot;Total Items: {proc_list.total_items}&quot;)
print(f&quot;Total Cost: ${proc_list.total_cost:,.2f}&quot;)
</code></pre>
<h2>Common Use Cases</h2>
<h3>1. Get Critical Orders</h3>
<pre><code class="language-python">critical = procurement.get_critical_orders(proc_list, days_ahead=7)
print(f&quot;Order immediately: {len(critical)} items&quot;)
</code></pre>
<h3>2. Create Purchase Order</h3>
<pre><code class="language-python">po = procurement.create_purchase_order(
    proc_list.items,
    supplier=&quot;Steel Fabricator&quot;,
    po_number=&quot;PO-2024-001&quot;
)
</code></pre>
<h3>3. Export to Excel</h3>
<pre><code class="language-python">procurement.export_to_excel(proc_list, &quot;procurement_list.xlsx&quot;)
</code></pre>
<h3>4. Material Aggregation</h3>
<pre><code class="language-python">materials_df = procurement.aggregate_by_material(items)
print(materials_df.head(10))
</code></pre>
<h2>Resources</h2>
<ul>
<li><strong>GitHub</strong>: <a href="https://github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR">OpenConstructionEstimate-DDC-CWICR</a></li>
<li><strong>DDC Book</strong>: Chapter 3.1 - Material Resource Planning</li>
</ul>

                </div>
              </div>
            </article>
            <aside class="skill-page-sidebar">
              <div class="sidebar-card">
                <div class="sidebar-title">Actions</div>
                <a href="https://github.com/openclaw/skills/tree/main/skills/datadrivenconstruction/cwicr-material-procurement/SKILL.md" target="_blank" rel="noopener" class="sidebar-btn sidebar-btn-primary">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
                  View on GitHub
                </a>
                <a href="https://clawdhub.com/datadrivenconstruction/cwicr-material-procurement" target="_blank" rel="noopener" class="sidebar-btn sidebar-btn-clawdhub">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><line x1="2" y1="12" x2="22" y2="12"/></svg>
                  View on ClawdHub
                </a>
                <a href="https://raw.githubusercontent.com/openclaw/skills/main/skills/datadrivenconstruction/cwicr-material-procurement/SKILL.md" download="SKILL.md" class="sidebar-btn sidebar-btn-secondary">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                  Download SKILL.md
                </a>
                <button onclick="sendToSecurityAuditor()" class="sidebar-btn sidebar-btn-security">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                  Security Check
                </button>
              </div>
              <div class="sidebar-card">
                <div class="sidebar-title">Details</div>
                <div class="sidebar-info">
                  <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Author</span>
                    <span class="sidebar-info-value">@datadrivenconstruction</span>
                  </div>
                  <div class="sidebar-info-item">
                    <span class="sidebar-info-label">Category</span>
                    <span class="sidebar-info-value">AI & LLMs</span>
                  </div>
                </div>
              </div>
            </aside>
          </div>
        
  <footer class="footer">
    <div class="footer-inner">
      <p class="footer-text" style="margin-bottom: 8px;"><a href="https://github.com/neonone123/moltdirectory" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none;">View on GitHub</a></p>
      <p class="footer-text" style="opacity: 0.6; font-size: 13px;">OpenClawDirectory.com is a community-run project and is not affiliated with the official OpenClaw team or Peter Steinberger. We are just fans of the lobster.</p>
    </div>
  </footer>
  <script>
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      if (newTheme === 'light') {
        html.setAttribute('data-theme', 'light');
      } else {
        html.removeAttribute('data-theme');
      }
      localStorage.setItem('theme', newTheme);
    }
    
    function copySkillContent(btn) {
      const wrapper = btn.closest('.skill-source-wrapper');
      const content = wrapper.querySelector('.markdown-content');
      if (content) {
        const text = content.innerText || content.textContent;
        navigator.clipboard.writeText(text).then(() => {
          btn.classList.add('copied');
          btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> Copied!';
          setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy';
          }, 2000);
        });
      }
    }

    async function sendToSecurityAuditor() {
      try {
        const contentElement = document.querySelector('.markdown-content');
        if (!contentElement) throw new Error('Could not find markdown content');
        const skillContent = contentElement.innerText || contentElement.textContent;
        localStorage.setItem('skillAuditContent', skillContent);
        window.open('/security-auditor', '_blank'); 
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function updateVoteWidget(widget, toolData) {
      if (!widget || !toolData) return;
      const upBtn = widget.querySelector('[data-vote="1"]');
      const downBtn = widget.querySelector('[data-vote="-1"]');
      const countNode = widget.querySelector('.vote-count');
      widget.dataset.rankScore = String(toolData.rankScore ?? 0);
      widget.dataset.viewerVote = String(toolData.viewerVote ?? 0);

      if (countNode) {
        countNode.textContent = toolData.displayCount || 'New';
      }
      if (upBtn) {
        upBtn.classList.toggle('is-active', Number(toolData.viewerVote) === 1);
      }
      if (downBtn) {
        downBtn.classList.toggle('is-active', Number(toolData.viewerVote) === -1);
      }
    }

    function setWidgetBusy(widget, busy) {
      widget.dataset.busy = busy ? '1' : '0';
      widget.querySelectorAll('.vote-btn').forEach((btn) => {
        btn.disabled = busy;
      });
    }

    function applySortMode(grid, mode) {
      const cards = [...grid.querySelectorAll('.skill-card[data-tool-id]')];
      cards.sort((a, b) => {
        if (mode === 'community') {
          const scoreDiff = Number(b.dataset.rankScore || 0) - Number(a.dataset.rankScore || 0);
          if (scoreDiff !== 0) return scoreDiff;
        }
        return Number(a.dataset.originalIndex || 0) - Number(b.dataset.originalIndex || 0);
      });
      cards.forEach((card) => grid.appendChild(card));
    }

    function bindSortToggle(toolbar, grid) {
      const buttons = toolbar.querySelectorAll('.sort-toggle-btn');
      const status = toolbar.querySelector('.sort-status');
      buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const mode = btn.dataset.sortMode;
          buttons.forEach((b) => b.classList.toggle('is-active', b === btn));
          applySortMode(grid, mode);
          status.textContent = mode === 'community' ? 'Community ranking active' : 'Original order active';
        });
      });
    }

    async function fetchScores(categoryId, toolIds) {
      const params = new URLSearchParams({
        categoryId,
        toolIds: toolIds.join(',')
      });
      const response = await fetch('/api/v1/scores?' + params.toString(), {
        method: 'GET',
        credentials: 'same-origin'
      });
      if (!response.ok) {
        throw new Error('Unable to fetch vote scores');
      }
      return response.json();
    }

    async function submitVote(widget, voteValue) {
      const categoryId = widget.dataset.categoryId;
      const toolId = widget.dataset.toolId;
      setWidgetBusy(widget, true);
      try {
        const response = await fetch('/api/v1/vote', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            categoryId,
            toolId,
            vote: voteValue
          })
        });
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload.error || 'Vote request failed');
        }
        if (payload.tool) {
          updateVoteWidget(widget, payload.tool);
          const card = widget.closest('.skill-card[data-tool-id]');
          if (card) {
            card.dataset.rankScore = String(payload.tool.rankScore ?? 0);
          }
        }
      } catch (error) {
        console.error(error);
      } finally {
        setWidgetBusy(widget, false);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const widgets = [...document.querySelectorAll('.vote-widget[data-category-id][data-tool-id]')];
      if (widgets.length === 0) return;

      const grouped = new Map();
      widgets.forEach((widget) => {
        const key = widget.dataset.categoryId;
        if (!grouped.has(key)) grouped.set(key, new Map());
        grouped.get(key).set(widget.dataset.toolId, widget);
      });

      for (const [categoryId, widgetMap] of grouped.entries()) {
        const toolIds = [...widgetMap.keys()];
        try {
          const data = await fetchScores(categoryId, toolIds);
          const byTool = new Map((data.tools || []).map((tool) => [tool.toolId, tool]));
          for (const [toolId, widget] of widgetMap.entries()) {
            const toolData = byTool.get(toolId);
            if (toolData) {
              updateVoteWidget(widget, toolData);
              const card = widget.closest('.skill-card[data-tool-id]');
              if (card) {
                card.dataset.rankScore = String(toolData.rankScore ?? 0);
              }
            }
          }
        } catch (error) {
          console.error(error);
        }
      }

      widgets.forEach((widget) => {
        widget.querySelectorAll('.vote-btn').forEach((btn) => {
          btn.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            if (widget.dataset.busy === '1') return;
            const voteValue = Number(btn.dataset.vote);
            submitVote(widget, voteValue).then(() => {
              const grid = widget.closest('.skills-grid[data-category-id]');
              const toolbar = document.querySelector('.sort-toolbar[data-category-id="' + widget.dataset.categoryId + '"]');
              const communityBtn = toolbar ? toolbar.querySelector('.sort-toggle-btn[data-sort-mode="community"]') : null;
              if (grid && communityBtn && communityBtn.classList.contains('is-active')) {
                applySortMode(grid, 'community');
              }
            });
          });
        });
      });

      document.querySelectorAll('.skills-grid[data-category-id]').forEach((grid) => {
        const categoryId = grid.dataset.categoryId;
        const toolbar = document.querySelector('.sort-toolbar[data-category-id="' + categoryId + '"]');
        if (!toolbar) return;
        bindSortToggle(toolbar, grid);
        applySortMode(grid, 'community');
      });
    });
  </script>
</body>
</html>